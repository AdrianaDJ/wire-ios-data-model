<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
<title>NSManagedObjectContext+zmessaging.m - Slather</title>
<link href="slather.css" media="all" rel="stylesheet">
</head>
<body>
<header><div class="row"><a href="index.html"><img src="logo.jpg" alt="Slather logo"></a></div></header><div class="row"><div id="reports">
<h2 class="cov_title">
<span>Coverage for "NSManagedObjectContext+zmessaging.m" : </span><span class="cov_medium">84.98%</span>
</h2>
<h4 class="cov_subtitle">(724 of 852 relevant lines covered)</h4>
<h4 class="cov_filepath">../Home/workspace/Utility jobs/Create a new version of framework/Source/ManagedObjectContext/NSManagedObjectContext+zmessaging.m</h4>
<table class="source_code">
<tr class="never">
<td class="num">1</td>
<td class="src"><pre><code class="objc">// </code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">2</td>
<td class="src"><pre><code class="objc">// Wire</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">3</td>
<td class="src"><pre><code class="objc">// Copyright (C) 2016 Wire Swiss GmbH</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">4</td>
<td class="src"><pre><code class="objc">// </code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">5</td>
<td class="src"><pre><code class="objc">// This program is free software: you can redistribute it and/or modify</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">6</td>
<td class="src"><pre><code class="objc">// it under the terms of the GNU General Public License as published by</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">7</td>
<td class="src"><pre><code class="objc">// the Free Software Foundation, either version 3 of the License, or</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">8</td>
<td class="src"><pre><code class="objc">// (at your option) any later version.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">9</td>
<td class="src"><pre><code class="objc">// </code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">10</td>
<td class="src"><pre><code class="objc">// This program is distributed in the hope that it will be useful,</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">11</td>
<td class="src"><pre><code class="objc">// but WITHOUT ANY WARRANTY; without even the implied warranty of</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">12</td>
<td class="src"><pre><code class="objc">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">13</td>
<td class="src"><pre><code class="objc">// GNU General Public License for more details.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">14</td>
<td class="src"><pre><code class="objc">// </code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">15</td>
<td class="src"><pre><code class="objc">// You should have received a copy of the GNU General Public License</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">16</td>
<td class="src"><pre><code class="objc">// along with this program. If not, see http://www.gnu.org/licenses/.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">17</td>
<td class="src"><pre><code class="objc">// </code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">18</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">19</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">20</td>
<td class="src"><pre><code class="objc">@import ZMUtilities;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">21</td>
<td class="src"><pre><code class="objc">@import UIKit;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">22</td>
<td class="src"><pre><code class="objc">@import Cryptobox;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">23</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">24</td>
<td class="src"><pre><code class="objc">#import "NSManagedObjectContext+zmessaging-Internal.h"</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">25</td>
<td class="src"><pre><code class="objc">#import "NSManagedObjectContext+tests.h"</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">26</td>
<td class="src"><pre><code class="objc">#import "ZMManagedObject.h"</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">27</td>
<td class="src"><pre><code class="objc">#import "ZMUser+Internal.h"</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">28</td>
<td class="src"><pre><code class="objc">#import "ZMSyncMergePolicy.h"</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">29</td>
<td class="src"><pre><code class="objc">#import "ZMConversation+Internal.h"</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">30</td>
<td class="src"><pre><code class="objc">#import "ZMUserDisplayNameGenerator.h"</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">31</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">32</td>
<td class="src"><pre><code class="objc">#import "ZMConversation+Internal.h"</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">33</td>
<td class="src"><pre><code class="objc">#import &lt;objc/runtime.h&gt;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">34</td>
<td class="src"><pre><code class="objc">#import &lt;libkern/OSAtomic.h&gt;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">35</td>
<td class="src"><pre><code class="objc">#import &lt;ZMUtilities/ZMUtilities-Swift.h&gt;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">36</td>
<td class="src"><pre><code class="objc">#import &lt;ZMCDataModel/ZMCDataModel-Swift.h&gt;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">37</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">38</td>
<td class="src"><pre><code class="objc">static NSString * const IsSyncContextKey = @"ZMIsSyncContext";</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">39</td>
<td class="src"><pre><code class="objc">static NSString * const IsSearchContextKey = @"ZMIsSearchContext";</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">40</td>
<td class="src"><pre><code class="objc">static NSString * const SyncContextKey = @"ZMSyncContext";</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">41</td>
<td class="src"><pre><code class="objc">static NSString * const UserInterfaceContextKey = @"ZMUserInterfaceContext";</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">42</td>
<td class="src"><pre><code class="objc">static NSString * const IsRefreshOfObjectsDisabled = @"ZMIsRefreshOfObjectsDisabled";</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">43</td>
<td class="src"><pre><code class="objc">static NSString * const IsUserInterfaceContextKey = @"ZMIsUserInterfaceContext";</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">44</td>
<td class="src"><pre><code class="objc">static NSString * const IsSaveDisabled = @"ZMIsSaveDisabled";</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">45</td>
<td class="src"><pre><code class="objc">static NSString * const IsFailingToSave = @"ZMIsFailingToSave";</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">46</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">47</td>
<td class="src"><pre><code class="objc">static BOOL UsesInMemoryStore;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">48</td>
<td class="src"><pre><code class="objc">static NSPersistentStoreCoordinator *sharedPersistentStoreCoordinator;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">49</td>
<td class="src"><pre><code class="objc">static NSPersistentStoreCoordinator *inMemorySharedPersistentStoreCoordinator;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">50</td>
<td class="src"><pre><code class="objc">static NSString * const ClearPersistentStoreOnStartKey = @"ZMClearPersistentStoreOnStart";</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">51</td>
<td class="src"><pre><code class="objc">static NSString * const TimeOfLastSaveKey = @"ZMTimeOfLastSave";</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">52</td>
<td class="src"><pre><code class="objc">static NSString * const FirstEnqueuedSaveKey = @"ZMTimeOfLastSave";</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">53</td>
<td class="src"><pre><code class="objc">static NSString * const MetadataKey = @"ZMMetadataKey";</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">54</td>
<td class="src"><pre><code class="objc">static NSString * const FailedToEstablishSessionStoreKey = @"FailedToEstablishSessionStoreKey";</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">55</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">56</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">57</td>
<td class="src"><pre><code class="objc">static dispatch_queue_t singletonContextIsolation(void);</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">58</td>
<td class="src"><pre><code class="objc">static NSManagedObjectContext *SharedUserInterfaceContext = nil;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">59</td>
<td class="src"><pre><code class="objc">static id applicationProtectedDataDidBecomeAvailableObserver = nil;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">60</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">61</td>
<td class="src"><pre><code class="objc">static char* const ZMLogTag ZM_UNUSED = "NSManagedObjectContext";</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">62</td>
<td class="src"><pre><code class="objc">//</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">63</td>
<td class="src"><pre><code class="objc">// For testing, we want to use an NSInMemoryStoreType (it's faster).</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">64</td>
<td class="src"><pre><code class="objc">// The only way for multiple contexts to share the same NSInMemoryStoreType is to share</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">65</td>
<td class="src"><pre><code class="objc">// the persistent store coordinator.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">66</td>
<td class="src"><pre><code class="objc">//</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">67</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">68</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">69</td>
<td class="src"><pre><code class="objc">@interface NSManagedObjectContext (CleanUp)</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">70</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">71</td>
<td class="src"><pre><code class="objc">- (void)refreshUnneededObjects;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">72</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">73</td>
<td class="src"><pre><code class="objc">@end</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">74</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">75</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">76</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">77</td>
<td class="src"><pre><code class="objc">@implementation NSManagedObjectContext (zmessaging)</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">78</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">79</td>
<td class="src"><pre><code class="objc">static BOOL storeIsReady = NO;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">80</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">81</td>
<td class="src"><pre><code class="objc">+ (BOOL)needsToPrepareLocalStore</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">82</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">5x</td>
</tr>
<tr class="covered">
<td class="num">83</td>
<td class="src"><pre><code class="objc">    NSError *error = nil;</code></pre></td>
<td class="coverage">5x</td>
</tr>
<tr class="covered">
<td class="num">84</td>
<td class="src"><pre><code class="objc">    NSManagedObjectModel *mom = [self loadManagedObjectModel];</code></pre></td>
<td class="coverage">5x</td>
</tr>
<tr class="covered">
<td class="num">85</td>
<td class="src"><pre><code class="objc">    NSDictionary *metadata = [NSPersistentStoreCoordinator metadataForPersistentStoreOfType:NSSQLiteStoreType</code></pre></td>
<td class="coverage">5x</td>
</tr>
<tr class="covered">
<td class="num">86</td>
<td class="src"><pre><code class="objc">                                                                                        URL:[self storeURL]</code></pre></td>
<td class="coverage">5x</td>
</tr>
<tr class="covered">
<td class="num">87</td>
<td class="src"><pre><code class="objc">                                                                                      error:&amp;error];</code></pre></td>
<td class="coverage">5x</td>
</tr>
<tr class="covered">
<td class="num">88</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">5x</td>
</tr>
<tr class="covered">
<td class="num">89</td>
<td class="src"><pre><code class="objc">    if (nil != error) {</code></pre></td>
<td class="coverage">5x</td>
</tr>
<tr class="covered">
<td class="num">90</td>
<td class="src"><pre><code class="objc">        ZMLogError(@"Cannot open store metadata: %@", error);</code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="covered">
<td class="num">91</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="covered">
<td class="num">92</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">5x</td>
</tr>
<tr class="covered">
<td class="num">93</td>
<td class="src"><pre><code class="objc">    BOOL needsMigration = ![mom isConfiguration:nil compatibleWithStoreMetadata:metadata];</code></pre></td>
<td class="coverage">5x</td>
</tr>
<tr class="covered">
<td class="num">94</td>
<td class="src"><pre><code class="objc">    return needsMigration || [self databaseExistsInCachesDirectory] || [self databaseExistsAndNotReadableDueToEncryption];</code></pre></td>
<td class="coverage">2x</td>
</tr>
<tr class="covered">
<td class="num">95</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">5x</td>
</tr>
<tr class="never">
<td class="num">96</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">97</td>
<td class="src"><pre><code class="objc">+ (void)prepareLocalStoreInternalBackingUpCorruptedDatabase:(BOOL)backupCorrputedDatabase completionHandler:(void (^)())completionHandler</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">98</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">1480x</td>
</tr>
<tr class="covered">
<td class="num">99</td>
<td class="src"><pre><code class="objc">    dispatch_block_t finally = ^() {</code></pre></td>
<td class="coverage">1480x</td>
</tr>
<tr class="covered">
<td class="num">100</td>
<td class="src"><pre><code class="objc">        dispatch_async(dispatch_get_main_queue(), ^{</code></pre></td>
<td class="coverage">1480x</td>
</tr>
<tr class="covered">
<td class="num">101</td>
<td class="src"><pre><code class="objc">            storeIsReady = YES;</code></pre></td>
<td class="coverage">1480x</td>
</tr>
<tr class="covered">
<td class="num">102</td>
<td class="src"><pre><code class="objc">            if (nil != completionHandler) {</code></pre></td>
<td class="coverage">1480x</td>
</tr>
<tr class="covered">
<td class="num">103</td>
<td class="src"><pre><code class="objc">                completionHandler();</code></pre></td>
<td class="coverage">14x</td>
</tr>
<tr class="covered">
<td class="num">104</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">14x</td>
</tr>
<tr class="covered">
<td class="num">105</td>
<td class="src"><pre><code class="objc">        });</code></pre></td>
<td class="coverage">1480x</td>
</tr>
<tr class="covered">
<td class="num">106</td>
<td class="src"><pre><code class="objc">    };</code></pre></td>
<td class="coverage">1480x</td>
</tr>
<tr class="covered">
<td class="num">107</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">1480x</td>
</tr>
<tr class="covered">
<td class="num">108</td>
<td class="src"><pre><code class="objc">    //just try to create psc, contexts will be created later when user session is initialized</code></pre></td>
<td class="coverage">1480x</td>
</tr>
<tr class="covered">
<td class="num">109</td>
<td class="src"><pre><code class="objc">    if (UsesInMemoryStore) {</code></pre></td>
<td class="coverage">1480x</td>
</tr>
<tr class="covered">
<td class="num">110</td>
<td class="src"><pre><code class="objc">        RequireString(inMemorySharedPersistentStoreCoordinator == nil, "In-Memory persistent store was not nil");</code></pre></td>
<td class="coverage">1460x</td>
</tr>
<tr class="covered">
<td class="num">111</td>
<td class="src"><pre><code class="objc">        inMemorySharedPersistentStoreCoordinator = [self inMemoryPersistentStoreCoordinator];</code></pre></td>
<td class="coverage">1460x</td>
</tr>
<tr class="covered">
<td class="num">112</td>
<td class="src"><pre><code class="objc">        finally();</code></pre></td>
<td class="coverage">1460x</td>
</tr>
<tr class="covered">
<td class="num">113</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">1460x</td>
</tr>
<tr class="covered">
<td class="num">114</td>
<td class="src"><pre><code class="objc">    else {</code></pre></td>
<td class="coverage">18x</td>
</tr>
<tr class="covered">
<td class="num">115</td>
<td class="src"><pre><code class="objc">        RequireString(sharedPersistentStoreCoordinator == nil, "Shared persistent store was not nil");</code></pre></td>
<td class="coverage">18x</td>
</tr>
<tr class="covered">
<td class="num">116</td>
<td class="src"><pre><code class="objc">        </code></pre></td>
<td class="coverage">18x</td>
</tr>
<tr class="covered">
<td class="num">117</td>
<td class="src"><pre><code class="objc">        // We need to handle the case when the database file is encrypted by iOS and user never entered the passcode</code></pre></td>
<td class="coverage">18x</td>
</tr>
<tr class="covered">
<td class="num">118</td>
<td class="src"><pre><code class="objc">        // We use default core data protection mode NSFileProtectionCompleteUntilFirstUserAuthentication</code></pre></td>
<td class="coverage">18x</td>
</tr>
<tr class="covered">
<td class="num">119</td>
<td class="src"><pre><code class="objc">        // This happens when</code></pre></td>
<td class="coverage">18x</td>
</tr>
<tr class="covered">
<td class="num">120</td>
<td class="src"><pre><code class="objc">        // (1) User has passcode enabled</code></pre></td>
<td class="coverage">18x</td>
</tr>
<tr class="covered">
<td class="num">121</td>
<td class="src"><pre><code class="objc">        // (2) User turns the phone on, but do not enter the passcode yet</code></pre></td>
<td class="coverage">18x</td>
</tr>
<tr class="covered">
<td class="num">122</td>
<td class="src"><pre><code class="objc">        // (3) App is awake on the background due to VoIP push notification</code></pre></td>
<td class="coverage">18x</td>
</tr>
<tr class="covered">
<td class="num">123</td>
<td class="src"><pre><code class="objc">        // We should wait then until the database is becoming available</code></pre></td>
<td class="coverage">18x</td>
</tr>
<tr class="covered">
<td class="num">124</td>
<td class="src"><pre><code class="objc">        if ([self databaseExistsAndNotReadableDueToEncryption]) {</code></pre></td>
<td class="coverage">18x</td>
</tr>
<tr class="covered">
<td class="num">125</td>
<td class="src"><pre><code class="objc">            ZM_WEAK(self);</code></pre></td>
<td class="coverage">2x</td>
</tr>
<tr class="covered">
<td class="num">126</td>
<td class="src"><pre><code class="objc">            NSAssert(applicationProtectedDataDidBecomeAvailableObserver == nil, @"prepareLocalStoreInternalBackingUpCorruptedDatabase: called twice");</code></pre></td>
<td class="coverage">2x</td>
</tr>
<tr class="covered">
<td class="num">127</td>
<td class="src"><pre><code class="objc">            </code></pre></td>
<td class="coverage">2x</td>
</tr>
<tr class="covered">
<td class="num">128</td>
<td class="src"><pre><code class="objc">            applicationProtectedDataDidBecomeAvailableObserver = [[NSNotificationCenter defaultCenter] addObserverForName:UIApplicationProtectedDataDidBecomeAvailable</code></pre></td>
<td class="coverage">2x</td>
</tr>
<tr class="covered">
<td class="num">129</td>
<td class="src"><pre><code class="objc">                                                                  object:nil</code></pre></td>
<td class="coverage">2x</td>
</tr>
<tr class="covered">
<td class="num">130</td>
<td class="src"><pre><code class="objc">                                                                   queue:nil</code></pre></td>
<td class="coverage">2x</td>
</tr>
<tr class="covered">
<td class="num">131</td>
<td class="src"><pre><code class="objc">                                                              usingBlock:^(NSNotification * _Nonnull __unused note) {</code></pre></td>
<td class="coverage">2x</td>
</tr>
<tr class="covered">
<td class="num">132</td>
<td class="src"><pre><code class="objc">                                                                  ZM_STRONG(self);</code></pre></td>
<td class="coverage">2x</td>
</tr>
<tr class="covered">
<td class="num">133</td>
<td class="src"><pre><code class="objc">                                                                  sharedPersistentStoreCoordinator = [self initPersistentStoreCoordinatorBackingUpCorrupedDatabases:backupCorrputedDatabase];</code></pre></td>
<td class="coverage">2x</td>
</tr>
<tr class="covered">
<td class="num">134</td>
<td class="src"><pre><code class="objc">                                                                  finally();</code></pre></td>
<td class="coverage">2x</td>
</tr>
<tr class="covered">
<td class="num">135</td>
<td class="src"><pre><code class="objc">                                                                  [[NSNotificationCenter defaultCenter] removeObserver:applicationProtectedDataDidBecomeAvailableObserver];</code></pre></td>
<td class="coverage">2x</td>
</tr>
<tr class="covered">
<td class="num">136</td>
<td class="src"><pre><code class="objc">                                                                  applicationProtectedDataDidBecomeAvailableObserver = nil;</code></pre></td>
<td class="coverage">2x</td>
</tr>
<tr class="covered">
<td class="num">137</td>
<td class="src"><pre><code class="objc">                                                              }];</code></pre></td>
<td class="coverage">2x</td>
</tr>
<tr class="covered">
<td class="num">138</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">2x</td>
</tr>
<tr class="covered">
<td class="num">139</td>
<td class="src"><pre><code class="objc">        else {</code></pre></td>
<td class="coverage">16x</td>
</tr>
<tr class="covered">
<td class="num">140</td>
<td class="src"><pre><code class="objc">            sharedPersistentStoreCoordinator = [self initPersistentStoreCoordinatorBackingUpCorrupedDatabases:backupCorrputedDatabase];</code></pre></td>
<td class="coverage">16x</td>
</tr>
<tr class="covered">
<td class="num">141</td>
<td class="src"><pre><code class="objc">            finally();</code></pre></td>
<td class="coverage">16x</td>
</tr>
<tr class="covered">
<td class="num">142</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">16x</td>
</tr>
<tr class="covered">
<td class="num">143</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">18x</td>
</tr>
<tr class="covered">
<td class="num">144</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">1480x</td>
</tr>
<tr class="never">
<td class="num">145</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">146</td>
<td class="src"><pre><code class="objc">+ (void)prepareLocalStoreSync:(BOOL)sync backingUpCorruptedDatabase:(BOOL)backupCorrputedDatabase completionHandler:(void(^)())completionHandler;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">147</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">14x</td>
</tr>
<tr class="covered">
<td class="num">148</td>
<td class="src"><pre><code class="objc">    (sync ? dispatch_sync : dispatch_async)(singletonContextIsolation(), ^{</code></pre></td>
<td class="coverage">14x</td>
</tr>
<tr class="covered">
<td class="num">149</td>
<td class="src"><pre><code class="objc">        [self prepareLocalStoreInternalBackingUpCorruptedDatabase:backupCorrputedDatabase completionHandler:completionHandler];</code></pre></td>
<td class="coverage">14x</td>
</tr>
<tr class="covered">
<td class="num">150</td>
<td class="src"><pre><code class="objc">    });</code></pre></td>
<td class="coverage">14x</td>
</tr>
<tr class="covered">
<td class="num">151</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">14x</td>
</tr>
<tr class="never">
<td class="num">152</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">153</td>
<td class="src"><pre><code class="objc">+ (BOOL)storeIsReady</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="missed">
<td class="num">154</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">155</td>
<td class="src"><pre><code class="objc">    return storeIsReady;</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">156</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="never">
<td class="num">157</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">158</td>
<td class="src"><pre><code class="objc">+ (NSPersistentStoreCoordinator *)requirePersistentStoreCoordinatorInternal</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">159</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">160</td>
<td class="src"><pre><code class="objc">    NSPersistentStoreCoordinator *psc = UsesInMemoryStore ? inMemorySharedPersistentStoreCoordinator : sharedPersistentStoreCoordinator;</code></pre></td>
<td class="coverage">1460x</td>
</tr>
<tr class="covered">
<td class="num">161</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">162</td>
<td class="src"><pre><code class="objc">    if (psc == nil) {</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">163</td>
<td class="src"><pre><code class="objc">        [self prepareLocalStoreInternalBackingUpCorruptedDatabase:NO completionHandler:nil];</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">164</td>
<td class="src"><pre><code class="objc">        psc = UsesInMemoryStore ? inMemorySharedPersistentStoreCoordinator : sharedPersistentStoreCoordinator;</code></pre></td>
<td class="coverage">1460x</td>
</tr>
<tr class="covered">
<td class="num">165</td>
<td class="src"><pre><code class="objc">        Require(psc != nil);</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">166</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">167</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">168</td>
<td class="src"><pre><code class="objc">    return psc;</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">169</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="never">
<td class="num">170</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">171</td>
<td class="src"><pre><code class="objc">+ (NSPersistentStoreCoordinator *)requirePersistentStoreCoordinator</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">172</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">2950x</td>
</tr>
<tr class="covered">
<td class="num">173</td>
<td class="src"><pre><code class="objc">    NSPersistentStoreCoordinator *psc = UsesInMemoryStore ? inMemorySharedPersistentStoreCoordinator : sharedPersistentStoreCoordinator;</code></pre></td>
<td class="coverage">2930x</td>
</tr>
<tr class="covered">
<td class="num">174</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">2950x</td>
</tr>
<tr class="covered">
<td class="num">175</td>
<td class="src"><pre><code class="objc">    if (psc == nil) {</code></pre></td>
<td class="coverage">2950x</td>
</tr>
<tr class="missed">
<td class="num">176</td>
<td class="src"><pre><code class="objc">        dispatch_sync(singletonContextIsolation(), ^() {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">177</td>
<td class="src"><pre><code class="objc">            [self prepareLocalStoreInternalBackingUpCorruptedDatabase:NO completionHandler:nil];</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">178</td>
<td class="src"><pre><code class="objc">        });</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">179</td>
<td class="src"><pre><code class="objc">        psc = UsesInMemoryStore ? inMemorySharedPersistentStoreCoordinator : sharedPersistentStoreCoordinator;</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">180</td>
<td class="src"><pre><code class="objc">        Require(psc != nil);</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">181</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">182</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">2950x</td>
</tr>
<tr class="covered">
<td class="num">183</td>
<td class="src"><pre><code class="objc">    return psc;</code></pre></td>
<td class="coverage">2950x</td>
</tr>
<tr class="covered">
<td class="num">184</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">2950x</td>
</tr>
<tr class="never">
<td class="num">185</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">186</td>
<td class="src"><pre><code class="objc">+ (instancetype)createUserInterfaceContext;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">187</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">188</td>
<td class="src"><pre><code class="objc">    __block NSManagedObjectContext *result = nil;</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">189</td>
<td class="src"><pre><code class="objc">    dispatch_sync(singletonContextIsolation(), ^{</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">190</td>
<td class="src"><pre><code class="objc">        result = SharedUserInterfaceContext;</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">191</td>
<td class="src"><pre><code class="objc">        if (result == nil) {</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">192</td>
<td class="src"><pre><code class="objc">            NSPersistentStoreCoordinator *psc = [self requirePersistentStoreCoordinatorInternal];</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">193</td>
<td class="src"><pre><code class="objc">            </code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">194</td>
<td class="src"><pre><code class="objc">            result = [[NSManagedObjectContext alloc] initWithConcurrencyType:NSMainQueueConcurrencyType];</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">195</td>
<td class="src"><pre><code class="objc">            [result markAsUIContext];</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">196</td>
<td class="src"><pre><code class="objc">            [result configureWithPersistentStoreCoordinator:psc];</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">197</td>
<td class="src"><pre><code class="objc">            result.mergePolicy = [[ZMSyncMergePolicy alloc] initWithMergeType:NSRollbackMergePolicyType];</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">198</td>
<td class="src"><pre><code class="objc">            SharedUserInterfaceContext = result;</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">199</td>
<td class="src"><pre><code class="objc">            [result continuouslyCheckForUnsavedChanges];</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">200</td>
<td class="src"><pre><code class="objc">            (void)result.globalManagedObjectContextObserver;</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">201</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">202</td>
<td class="src"><pre><code class="objc">    });</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">203</td>
<td class="src"><pre><code class="objc">    return result;</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">204</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="never">
<td class="num">205</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">206</td>
<td class="src"><pre><code class="objc">+ (void)resetUserInterfaceContext</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">207</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">4410x</td>
</tr>
<tr class="covered">
<td class="num">208</td>
<td class="src"><pre><code class="objc">    dispatch_async(singletonContextIsolation(), ^{</code></pre></td>
<td class="coverage">4410x</td>
</tr>
<tr class="covered">
<td class="num">209</td>
<td class="src"><pre><code class="objc">        SharedUserInterfaceContext = nil;</code></pre></td>
<td class="coverage">4410x</td>
</tr>
<tr class="covered">
<td class="num">210</td>
<td class="src"><pre><code class="objc">    });</code></pre></td>
<td class="coverage">4410x</td>
</tr>
<tr class="covered">
<td class="num">211</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">4410x</td>
</tr>
<tr class="never">
<td class="num">212</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">213</td>
<td class="src"><pre><code class="objc">+ (instancetype)createSyncContext;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">214</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">1480x</td>
</tr>
<tr class="covered">
<td class="num">215</td>
<td class="src"><pre><code class="objc">    NSPersistentStoreCoordinator *psc = [self requirePersistentStoreCoordinator];</code></pre></td>
<td class="coverage">1480x</td>
</tr>
<tr class="covered">
<td class="num">216</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage">1480x</td>
</tr>
<tr class="covered">
<td class="num">217</td>
<td class="src"><pre><code class="objc">    NSManagedObjectContext *moc = [[self alloc] initWithConcurrencyType:NSPrivateQueueConcurrencyType];</code></pre></td>
<td class="coverage">1480x</td>
</tr>
<tr class="covered">
<td class="num">218</td>
<td class="src"><pre><code class="objc">    [moc markAsSyncContext];</code></pre></td>
<td class="coverage">1480x</td>
</tr>
<tr class="covered">
<td class="num">219</td>
<td class="src"><pre><code class="objc">    [moc configureWithPersistentStoreCoordinator:psc];</code></pre></td>
<td class="coverage">1480x</td>
</tr>
<tr class="covered">
<td class="num">220</td>
<td class="src"><pre><code class="objc">    moc.undoManager = nil;</code></pre></td>
<td class="coverage">1480x</td>
</tr>
<tr class="covered">
<td class="num">221</td>
<td class="src"><pre><code class="objc">    moc.mergePolicy = [[ZMSyncMergePolicy alloc] initWithMergeType:NSMergeByPropertyObjectTrumpMergePolicyType];</code></pre></td>
<td class="coverage">1480x</td>
</tr>
<tr class="covered">
<td class="num">222</td>
<td class="src"><pre><code class="objc">    return moc;</code></pre></td>
<td class="coverage">1480x</td>
</tr>
<tr class="covered">
<td class="num">223</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">1480x</td>
</tr>
<tr class="never">
<td class="num">224</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">225</td>
<td class="src"><pre><code class="objc">+ (instancetype)createSearchContext;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">226</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">227</td>
<td class="src"><pre><code class="objc">    NSPersistentStoreCoordinator *psc = [self requirePersistentStoreCoordinator];</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">228</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">229</td>
<td class="src"><pre><code class="objc">    NSManagedObjectContext *moc = [[NSManagedObjectContext alloc] initWithConcurrencyType:NSPrivateQueueConcurrencyType];</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">230</td>
<td class="src"><pre><code class="objc">    [moc markAsSearchContext];</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">231</td>
<td class="src"><pre><code class="objc">    [moc configureWithPersistentStoreCoordinator:psc];</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">232</td>
<td class="src"><pre><code class="objc">    moc.undoManager = nil;</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">233</td>
<td class="src"><pre><code class="objc">    moc.mergePolicy = [[ZMSyncMergePolicy alloc] initWithMergeType:NSRollbackMergePolicyType];</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">234</td>
<td class="src"><pre><code class="objc">    return moc;</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">235</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="never">
<td class="num">236</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">237</td>
<td class="src"><pre><code class="objc">- (void)configureWithPersistentStoreCoordinator:(NSPersistentStoreCoordinator *)psc;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">238</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">4420x</td>
</tr>
<tr class="covered">
<td class="num">239</td>
<td class="src"><pre><code class="objc">    RequireString(self.zm_isSyncContext || self.zm_isUserInterfaceContext || self.zm_isSearchContext, "Context is not marked, yet");</code></pre></td>
<td class="coverage">4420x</td>
</tr>
<tr class="covered">
<td class="num">240</td>
<td class="src"><pre><code class="objc">    [self createDispatchGroups];</code></pre></td>
<td class="coverage">4420x</td>
</tr>
<tr class="covered">
<td class="num">241</td>
<td class="src"><pre><code class="objc">    self.persistentStoreCoordinator = psc;</code></pre></td>
<td class="coverage">4420x</td>
</tr>
<tr class="covered">
<td class="num">242</td>
<td class="src"><pre><code class="objc">    [self ensureSingletonsExist];</code></pre></td>
<td class="coverage">4420x</td>
</tr>
<tr class="covered">
<td class="num">243</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">4420x</td>
</tr>
<tr class="never">
<td class="num">244</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">245</td>
<td class="src"><pre><code class="objc">- (BOOL)zm_isSyncContext;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">246</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">19000x</td>
</tr>
<tr class="covered">
<td class="num">247</td>
<td class="src"><pre><code class="objc">    return [self.userInfo[IsSyncContextKey] boolValue];</code></pre></td>
<td class="coverage">19000x</td>
</tr>
<tr class="covered">
<td class="num">248</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">19000x</td>
</tr>
<tr class="never">
<td class="num">249</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">250</td>
<td class="src"><pre><code class="objc">- (BOOL)zm_isUserInterfaceContext;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">251</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">252</td>
<td class="src"><pre><code class="objc">    return [self.userInfo[IsUserInterfaceContextKey] boolValue];</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">253</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">254</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">255</td>
<td class="src"><pre><code class="objc">- (BOOL)zm_isSearchContext;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">256</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">257</td>
<td class="src"><pre><code class="objc">    return [self.userInfo[IsSearchContextKey] boolValue];</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">258</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="never">
<td class="num">259</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">260</td>
<td class="src"><pre><code class="objc">- (NSManagedObjectContext*)zm_syncContext</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">261</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">262</td>
<td class="src"><pre><code class="objc">    if (self.zm_isSyncContext) {</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">263</td>
<td class="src"><pre><code class="objc">        return self;</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">264</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="missed">
<td class="num">265</td>
<td class="src"><pre><code class="objc">    else {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">266</td>
<td class="src"><pre><code class="objc">        UnownedNSObject *unownedContext = self.userInfo[SyncContextKey];</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">267</td>
<td class="src"><pre><code class="objc">        if (nil != unownedContext) {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">268</td>
<td class="src"><pre><code class="objc">            return (NSManagedObjectContext *)unownedContext.unbox;</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">269</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">270</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">271</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="missed">
<td class="num">272</td>
<td class="src"><pre><code class="objc">    return nil;</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">273</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="never">
<td class="num">274</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">275</td>
<td class="src"><pre><code class="objc">- (void)setZm_syncContext:(NSManagedObjectContext *)zm_syncContext</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">276</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">277</td>
<td class="src"><pre><code class="objc">    self.userInfo[SyncContextKey] = [[UnownedNSObject alloc] init:zm_syncContext];</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">278</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="never">
<td class="num">279</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">280</td>
<td class="src"><pre><code class="objc">- (NSManagedObjectContext*)zm_userInterfaceContext</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">281</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">21x</td>
</tr>
<tr class="covered">
<td class="num">282</td>
<td class="src"><pre><code class="objc">    if (self.zm_isUserInterfaceContext) {</code></pre></td>
<td class="coverage">21x</td>
</tr>
<tr class="covered">
<td class="num">283</td>
<td class="src"><pre><code class="objc">        return self;</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">284</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">285</td>
<td class="src"><pre><code class="objc">    else {</code></pre></td>
<td class="coverage">20x</td>
</tr>
<tr class="covered">
<td class="num">286</td>
<td class="src"><pre><code class="objc">        UnownedNSObject *unownedContext = self.userInfo[UserInterfaceContextKey];</code></pre></td>
<td class="coverage">20x</td>
</tr>
<tr class="covered">
<td class="num">287</td>
<td class="src"><pre><code class="objc">        if (nil != unownedContext) {</code></pre></td>
<td class="coverage">20x</td>
</tr>
<tr class="covered">
<td class="num">288</td>
<td class="src"><pre><code class="objc">            return (NSManagedObjectContext *)unownedContext.unbox;</code></pre></td>
<td class="coverage">20x</td>
</tr>
<tr class="covered">
<td class="num">289</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">20x</td>
</tr>
<tr class="covered">
<td class="num">290</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">20x</td>
</tr>
<tr class="covered">
<td class="num">291</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">21x</td>
</tr>
<tr class="missed">
<td class="num">292</td>
<td class="src"><pre><code class="objc">    return nil;</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">293</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">21x</td>
</tr>
<tr class="never">
<td class="num">294</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">295</td>
<td class="src"><pre><code class="objc">- (void)setZm_userInterfaceContext:(NSManagedObjectContext *)zm_userInterfaceContext</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">296</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">297</td>
<td class="src"><pre><code class="objc">    self.userInfo[UserInterfaceContextKey] = [[UnownedNSObject alloc] init:zm_userInterfaceContext];</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">298</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="never">
<td class="num">299</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">300</td>
<td class="src"><pre><code class="objc">- (BOOL)zm_isRefreshOfObjectsDisabled;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">301</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">343x</td>
</tr>
<tr class="covered">
<td class="num">302</td>
<td class="src"><pre><code class="objc">    return [self.userInfo[IsRefreshOfObjectsDisabled] boolValue];</code></pre></td>
<td class="coverage">343x</td>
</tr>
<tr class="covered">
<td class="num">303</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">343x</td>
</tr>
<tr class="never">
<td class="num">304</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">305</td>
<td class="src"><pre><code class="objc">- (BOOL)zm_shouldRefreshObjectsWithSyncContextPolicy</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">306</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">2680x</td>
</tr>
<tr class="covered">
<td class="num">307</td>
<td class="src"><pre><code class="objc">    return self.zm_isSyncContext &amp;&amp; !self.zm_isRefreshOfObjectsDisabled;</code></pre></td>
<td class="coverage">343x</td>
</tr>
<tr class="covered">
<td class="num">308</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">2680x</td>
</tr>
<tr class="never">
<td class="num">309</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">310</td>
<td class="src"><pre><code class="objc">- (BOOL)zm_shouldRefreshObjectsWithUIContextPolicy</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="missed">
<td class="num">311</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">312</td>
<td class="src"><pre><code class="objc">    return self.zm_isUserInterfaceContext &amp;&amp; !self.zm_isRefreshOfObjectsDisabled;</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">313</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="never">
<td class="num">314</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">315</td>
<td class="src"><pre><code class="objc">+ (void)setUseInMemoryStore:(BOOL)useInMemoryStore;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">316</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">1480x</td>
</tr>
<tr class="covered">
<td class="num">317</td>
<td class="src"><pre><code class="objc">    UsesInMemoryStore = useInMemoryStore;</code></pre></td>
<td class="coverage">1480x</td>
</tr>
<tr class="covered">
<td class="num">318</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">1480x</td>
</tr>
<tr class="never">
<td class="num">319</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">320</td>
<td class="src"><pre><code class="objc">+ (NSPersistentStoreCoordinator *)inMemoryPersistentStoreCoordinator;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">321</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">1460x</td>
</tr>
<tr class="covered">
<td class="num">322</td>
<td class="src"><pre><code class="objc">    NSManagedObjectModel *mom = [self loadManagedObjectModel];</code></pre></td>
<td class="coverage">1460x</td>
</tr>
<tr class="covered">
<td class="num">323</td>
<td class="src"><pre><code class="objc">    NSPersistentStoreCoordinator* persistentStoreCoordinator = [[NSPersistentStoreCoordinator alloc] initWithManagedObjectModel:mom];</code></pre></td>
<td class="coverage">1460x</td>
</tr>
<tr class="covered">
<td class="num">324</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">1460x</td>
</tr>
<tr class="covered">
<td class="num">325</td>
<td class="src"><pre><code class="objc">    NSError *error = nil;</code></pre></td>
<td class="coverage">1460x</td>
</tr>
<tr class="covered">
<td class="num">326</td>
<td class="src"><pre><code class="objc">    NSPersistentStore *store = [persistentStoreCoordinator addPersistentStoreWithType:NSInMemoryStoreType</code></pre></td>
<td class="coverage">1460x</td>
</tr>
<tr class="covered">
<td class="num">327</td>
<td class="src"><pre><code class="objc">                                                                        configuration:nil</code></pre></td>
<td class="coverage">1460x</td>
</tr>
<tr class="covered">
<td class="num">328</td>
<td class="src"><pre><code class="objc">                                                                                  URL:nil</code></pre></td>
<td class="coverage">1460x</td>
</tr>
<tr class="covered">
<td class="num">329</td>
<td class="src"><pre><code class="objc">                                                                              options:nil</code></pre></td>
<td class="coverage">1460x</td>
</tr>
<tr class="covered">
<td class="num">330</td>
<td class="src"><pre><code class="objc">                                                                                error:&amp;error];</code></pre></td>
<td class="coverage">1460x</td>
</tr>
<tr class="covered">
<td class="num">331</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">1460x</td>
</tr>
<tr class="covered">
<td class="num">332</td>
<td class="src"><pre><code class="objc">    NSAssert(store != nil, @"Unable to create in-memory Core Data store: %@", error);</code></pre></td>
<td class="coverage">1460x</td>
</tr>
<tr class="covered">
<td class="num">333</td>
<td class="src"><pre><code class="objc">    NOT_USED(store);</code></pre></td>
<td class="coverage">1460x</td>
</tr>
<tr class="covered">
<td class="num">334</td>
<td class="src"><pre><code class="objc">    return persistentStoreCoordinator;</code></pre></td>
<td class="coverage">1460x</td>
</tr>
<tr class="covered">
<td class="num">335</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">1460x</td>
</tr>
<tr class="never">
<td class="num">336</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">337</td>
<td class="src"><pre><code class="objc">+ (void)setClearPersistentStoreOnStart:(BOOL)flag;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="missed">
<td class="num">338</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">339</td>
<td class="src"><pre><code class="objc">    if (flag) {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">340</td>
<td class="src"><pre><code class="objc">        [[NSUserDefaults standardUserDefaults] setBool:YES forKey:ClearPersistentStoreOnStartKey];</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">341</td>
<td class="src"><pre><code class="objc">    } else {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">342</td>
<td class="src"><pre><code class="objc">        [[NSUserDefaults standardUserDefaults] removeObjectForKey:ClearPersistentStoreOnStartKey];</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">343</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">344</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="never">
<td class="num">345</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">346</td>
<td class="src"><pre><code class="objc">+ (void)clearPersistentStoreOnStart;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">347</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">348</td>
<td class="src"><pre><code class="objc">    dispatch_once(&amp;clearStoreOnceToken, ^{</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">349</td>
<td class="src"><pre><code class="objc">        if ([[NSUserDefaults standardUserDefaults] boolForKey:ClearPersistentStoreOnStartKey]) {</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="missed">
<td class="num">350</td>
<td class="src"><pre><code class="objc">            [[NSUserDefaults standardUserDefaults] removeObjectForKey:ClearPersistentStoreOnStartKey];</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">351</td>
<td class="src"><pre><code class="objc">            [self removePersistentStoreFromFilesystemAndCopyToBackup:NO];</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">352</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">353</td>
<td class="src"><pre><code class="objc">    });</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">354</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="never">
<td class="num">355</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">356</td>
<td class="src"><pre><code class="objc">- (NSMutableSet *)zm_failedToEstablishSessionStore</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">357</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">143x</td>
</tr>
<tr class="covered">
<td class="num">358</td>
<td class="src"><pre><code class="objc">    if (!self.zm_isSyncContext) {</code></pre></td>
<td class="coverage">143x</td>
</tr>
<tr class="missed">
<td class="num">359</td>
<td class="src"><pre><code class="objc">        return nil;</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">360</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">361</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">143x</td>
</tr>
<tr class="covered">
<td class="num">362</td>
<td class="src"><pre><code class="objc">    if (nil == self.userInfo[FailedToEstablishSessionStoreKey]) {</code></pre></td>
<td class="coverage">143x</td>
</tr>
<tr class="covered">
<td class="num">363</td>
<td class="src"><pre><code class="objc">        self.userInfo[FailedToEstablishSessionStoreKey] = [NSMutableSet set];</code></pre></td>
<td class="coverage">14x</td>
</tr>
<tr class="covered">
<td class="num">364</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">14x</td>
</tr>
<tr class="covered">
<td class="num">365</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">143x</td>
</tr>
<tr class="covered">
<td class="num">366</td>
<td class="src"><pre><code class="objc">    return self.userInfo[FailedToEstablishSessionStoreKey];</code></pre></td>
<td class="coverage">143x</td>
</tr>
<tr class="covered">
<td class="num">367</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">143x</td>
</tr>
<tr class="never">
<td class="num">368</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">369</td>
<td class="src"><pre><code class="objc">/// @param copyToBackup: if true, will dump the database to a safe location before deleting it</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">370</td>
<td class="src"><pre><code class="objc">+ (void)removePersistentStoreFromFilesystemAndCopyToBackup:(BOOL)copyToBackup;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">371</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="covered">
<td class="num">372</td>
<td class="src"><pre><code class="objc">    // Enumerate all files in the store directory and find the ones that match the store name.</code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="covered">
<td class="num">373</td>
<td class="src"><pre><code class="objc">    // We need to do this, because the store consists of several files.</code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="covered">
<td class="num">374</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="covered">
<td class="num">375</td>
<td class="src"><pre><code class="objc">    NSURL *const storeFileURL = [self storeURL];</code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="covered">
<td class="num">376</td>
<td class="src"><pre><code class="objc">    NSString * const storeName = [storeFileURL lastPathComponent];</code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="covered">
<td class="num">377</td>
<td class="src"><pre><code class="objc">    NSURL *storeFolder;</code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="covered">
<td class="num">378</td>
<td class="src"><pre><code class="objc">    if (![storeFileURL getResourceValue:&amp;storeFolder forKey:NSURLParentDirectoryURLKey error:NULL]) {</code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="missed">
<td class="num">379</td>
<td class="src"><pre><code class="objc">        return;</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">380</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">381</td>
<td class="src"><pre><code class="objc">    NSFileManager *fm = [NSFileManager defaultManager];</code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="covered">
<td class="num">382</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="covered">
<td class="num">383</td>
<td class="src"><pre><code class="objc">    if(copyToBackup) {</code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="covered">
<td class="num">384</td>
<td class="src"><pre><code class="objc">        </code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">385</td>
<td class="src"><pre><code class="objc">        NSURL *rootFolder;</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">386</td>
<td class="src"><pre><code class="objc">        if ([storeFolder getResourceValue:&amp;rootFolder forKey:NSURLParentDirectoryURLKey error:NULL]) {</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">387</td>
<td class="src"><pre><code class="objc">            NSString *timeStamp = [NSString stringWithFormat:@"DB-%lu.bak", (unsigned long)(1000 *[NSDate date].timeIntervalSince1970)];</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">388</td>
<td class="src"><pre><code class="objc">            NSURL *backupFolder = [rootFolder URLByAppendingPathComponent:timeStamp];</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">389</td>
<td class="src"><pre><code class="objc">            [backupFolder setResourceValue:@YES forKey:NSURLIsExcludedFromBackupKey error:nil];</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">390</td>
<td class="src"><pre><code class="objc">            </code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">391</td>
<td class="src"><pre><code class="objc">            NSError *copyError;</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">392</td>
<td class="src"><pre><code class="objc">            if(![fm copyItemAtURL:storeFolder toURL:backupFolder error:&amp;copyError]) {</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="missed">
<td class="num">393</td>
<td class="src"><pre><code class="objc">                ZMLogError(@"Failed to copy to backup folder: %@", copyError);</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">394</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">395</td>
<td class="src"><pre><code class="objc">            else {</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">396</td>
<td class="src"><pre><code class="objc">                ZMLogWarn(@"Copied backup of corrupted DB to: %@", backupFolder.absoluteString);</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">397</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">398</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="missed">
<td class="num">399</td>
<td class="src"><pre><code class="objc">        else {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">400</td>
<td class="src"><pre><code class="objc">            ZMLogError(@"Failed to copy to backup folder: can't access root folder of %@", storeFolder);</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">401</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">402</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">403</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="covered">
<td class="num">404</td>
<td class="src"><pre><code class="objc">    for (NSURL *fileURL in [fm enumeratorAtURL:storeFolder includingPropertiesForKeys:@[NSURLNameKey] options:NSDirectoryEnumerationSkipsSubdirectoryDescendants errorHandler:nil]) {</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">405</td>
<td class="src"><pre><code class="objc">        NSError *error = nil;</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">406</td>
<td class="src"><pre><code class="objc">        NSString *name;</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">407</td>
<td class="src"><pre><code class="objc">        if (! [fileURL getResourceValue:&amp;name forKey:NSURLNameKey error:&amp;error]) {</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="missed">
<td class="num">408</td>
<td class="src"><pre><code class="objc">            ZMLogDebug(@"Skipping item \"%@\" because we can't get the name: %@", fileURL.path, error);</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">409</td>
<td class="src"><pre><code class="objc">            continue;</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">410</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">411</td>
<td class="src"><pre><code class="objc">        // "external binary data" is stored inside ".storeName_SUPPORT"</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">412</td>
<td class="src"><pre><code class="objc">        if ([name hasPrefix:storeName] ||</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">413</td>
<td class="src"><pre><code class="objc">            [name hasPrefix:[NSString stringWithFormat:@".%@_", storeName]])</code></pre></td>
<td class="coverage">26x</td>
</tr>
<tr class="covered">
<td class="num">414</td>
<td class="src"><pre><code class="objc">        {</code></pre></td>
<td class="coverage">9x</td>
</tr>
<tr class="covered">
<td class="num">415</td>
<td class="src"><pre><code class="objc">            if (! [fm removeItemAtURL:fileURL error:&amp;error]) {</code></pre></td>
<td class="coverage">9x</td>
</tr>
<tr class="missed">
<td class="num">416</td>
<td class="src"><pre><code class="objc">                ZMLogError(@"Unable to delete item \"%@\": %@", fileURL.path, error);</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">417</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">418</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">9x</td>
</tr>
<tr class="covered">
<td class="num">419</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">420</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="never">
<td class="num">421</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">422</td>
<td class="src"><pre><code class="objc">static dispatch_once_t storeURLOnceToken;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">423</td>
<td class="src"><pre><code class="objc">static dispatch_once_t clearStoreOnceToken;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">424</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">425</td>
<td class="src"><pre><code class="objc">+ (void)resetSharedPersistentStoreCoordinator;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">426</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">4440x</td>
</tr>
<tr class="covered">
<td class="num">427</td>
<td class="src"><pre><code class="objc">    inMemorySharedPersistentStoreCoordinator = nil;</code></pre></td>
<td class="coverage">4440x</td>
</tr>
<tr class="covered">
<td class="num">428</td>
<td class="src"><pre><code class="objc">    sharedPersistentStoreCoordinator = nil;</code></pre></td>
<td class="coverage">4440x</td>
</tr>
<tr class="covered">
<td class="num">429</td>
<td class="src"><pre><code class="objc">    storeURLOnceToken = 0;</code></pre></td>
<td class="coverage">4440x</td>
</tr>
<tr class="covered">
<td class="num">430</td>
<td class="src"><pre><code class="objc">    clearStoreOnceToken = 0;</code></pre></td>
<td class="coverage">4440x</td>
</tr>
<tr class="covered">
<td class="num">431</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">4440x</td>
</tr>
<tr class="never">
<td class="num">432</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">433</td>
<td class="src"><pre><code class="objc">+ (NSPersistentStoreCoordinator *)onDiskPersistentStoreCoordinator</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="missed">
<td class="num">434</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">435</td>
<td class="src"><pre><code class="objc">    return sharedPersistentStoreCoordinator;</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">436</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="never">
<td class="num">437</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">438</td>
<td class="src"><pre><code class="objc">+ (NSPersistentStoreCoordinator *)initPersistentStoreCoordinatorBackingUpCorrupedDatabases:(BOOL)backupCorruptedDatabase;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">439</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">440</td>
<td class="src"><pre><code class="objc">    [self clearPersistentStoreOnStart];</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">441</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">442</td>
<td class="src"><pre><code class="objc">    [self moveDatabaseFromCachesToApplicationSupportIfNeeded];</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">443</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">444</td>
<td class="src"><pre><code class="objc">    NSError *error = nil;</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">445</td>
<td class="src"><pre><code class="objc">    NSManagedObjectModel *mom = [self loadManagedObjectModel];</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">446</td>
<td class="src"><pre><code class="objc">    NSPersistentStoreCoordinator* psc = [[NSPersistentStoreCoordinator alloc] initWithManagedObjectModel:mom];</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">447</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">448</td>
<td class="src"><pre><code class="objc">    NSError *metadataError = nil;</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">449</td>
<td class="src"><pre><code class="objc">    NSDictionary *sourceMetadata = [NSPersistentStoreCoordinator metadataForPersistentStoreOfType:NSSQLiteStoreType URL:[self storeURL] error:&amp;metadataError];</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">450</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">451</td>
<td class="src"><pre><code class="objc">    // Something happened while reading the current database metadata</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">452</td>
<td class="src"><pre><code class="objc">    if (nil != metadataError) {</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">453</td>
<td class="src"><pre><code class="objc">        ZMLogError(@"Error reading store metadata: %@", metadataError);</code></pre></td>
<td class="coverage">6x</td>
</tr>
<tr class="covered">
<td class="num">454</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">6x</td>
</tr>
<tr class="covered">
<td class="num">455</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">456</td>
<td class="src"><pre><code class="objc">    NSString *oldModelVersion = [sourceMetadata[NSStoreModelVersionIdentifiersKey] firstObject];</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">457</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">458</td>
<td class="src"><pre><code class="objc">    // Between non-E2EE and E2EE we should not migrate the DB for privacy reasons.</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">459</td>
<td class="src"><pre><code class="objc">    // We know that the old mom is a version supporting E2EE when it</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">460</td>
<td class="src"><pre><code class="objc">    // contains the 'ClientMessage' entity or is at least of version 1.25</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">461</td>
<td class="src"><pre><code class="objc">    BOOL otrBuild = [[sourceMetadata[NSStoreModelVersionHashesKey] allKeys] containsObject:ZMClientMessage.entityName];</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">462</td>
<td class="src"><pre><code class="objc">    BOOL atLeastVersion1_25 = oldModelVersion != nil &amp;&amp;  [oldModelVersion compare:@"1.25" options:NSNumericSearch] != NSOrderedDescending;</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">463</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">464</td>
<td class="src"><pre><code class="objc">    // Unfortunately the 1.24 Release has a mom version of 1.3 but we do not want to migrate from it</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">465</td>
<td class="src"><pre><code class="objc">    // This additional check is also important as the string comparison with NSNumericSearch will return</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">466</td>
<td class="src"><pre><code class="objc">    // NSOrderedAscending for 1.25 and 1.30 but NSOrderedDescending for 1.25 and 1.3</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">467</td>
<td class="src"><pre><code class="objc">    NSString *currentModelIdentifier = mom.versionIdentifiers.anyObject;</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">468</td>
<td class="src"><pre><code class="objc">    BOOL newerOTRVersion = atLeastVersion1_25 &amp;&amp; ![oldModelVersion isEqualToString:@"1.3"];</code></pre></td>
<td class="coverage">2x</td>
</tr>
<tr class="covered">
<td class="num">469</td>
<td class="src"><pre><code class="objc">    BOOL shouldMigrate = otrBuild || newerOTRVersion;</code></pre></td>
<td class="coverage">7x</td>
</tr>
<tr class="covered">
<td class="num">470</td>
<td class="src"><pre><code class="objc">    BOOL isSameAsCurrent =  [currentModelIdentifier isEqualToString:oldModelVersion]; // this is used to avoid migrating internal</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">471</td>
<td class="src"><pre><code class="objc">    // builds when we update the DB internally</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">472</td>
<td class="src"><pre><code class="objc">    // between releases</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">473</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">474</td>
<td class="src"><pre><code class="objc">    if (shouldMigrate &amp;&amp; !isSameAsCurrent) {</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">475</td>
<td class="src"><pre><code class="objc">        NSDictionary *options = [self persistentStoreOptionsDictionarySupportingMigration:YES];</code></pre></td>
<td class="coverage">8x</td>
</tr>
<tr class="covered">
<td class="num">476</td>
<td class="src"><pre><code class="objc">        NSPersistentStore *store = [psc addPersistentStoreWithType:NSSQLiteStoreType configuration:nil URL:[self storeURL] options:options error:&amp;error];</code></pre></td>
<td class="coverage">8x</td>
</tr>
<tr class="covered">
<td class="num">477</td>
<td class="src"><pre><code class="objc">        NSString *errorString = [NSString stringWithFormat:@"when adding persistent store: %@", error];</code></pre></td>
<td class="coverage">8x</td>
</tr>
<tr class="covered">
<td class="num">478</td>
<td class="src"><pre><code class="objc">        RequireString(nil != store, "Unable to perform migration and create SQLite Core Data store: %s. "</code></pre></td>
<td class="coverage">8x</td>
</tr>
<tr class="covered">
<td class="num">479</td>
<td class="src"><pre><code class="objc">                      "-- Old model version was: %s, current version: %s, otr build: %d",</code></pre></td>
<td class="coverage">8x</td>
</tr>
<tr class="covered">
<td class="num">480</td>
<td class="src"><pre><code class="objc">                      errorString.UTF8String,</code></pre></td>
<td class="coverage">8x</td>
</tr>
<tr class="covered">
<td class="num">481</td>
<td class="src"><pre><code class="objc">                      oldModelVersion.UTF8String,</code></pre></td>
<td class="coverage">8x</td>
</tr>
<tr class="covered">
<td class="num">482</td>
<td class="src"><pre><code class="objc">                      currentModelIdentifier.UTF8String,</code></pre></td>
<td class="coverage">8x</td>
</tr>
<tr class="covered">
<td class="num">483</td>
<td class="src"><pre><code class="objc">                      (int) otrBuild);</code></pre></td>
<td class="coverage">8x</td>
</tr>
<tr class="covered">
<td class="num">484</td>
<td class="src"><pre><code class="objc">        if (nil != store) {</code></pre></td>
<td class="coverage">8x</td>
</tr>
<tr class="covered">
<td class="num">485</td>
<td class="src"><pre><code class="objc">            return psc;</code></pre></td>
<td class="coverage">8x</td>
</tr>
<tr class="covered">
<td class="num">486</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">8x</td>
</tr>
<tr class="covered">
<td class="num">487</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">8x</td>
</tr>
<tr class="covered">
<td class="num">488</td>
<td class="src"><pre><code class="objc">    [self addPersistentStoreBackingUpCorruptedDatabases:backupCorruptedDatabase toPSC:psc];</code></pre></td>
<td class="coverage">11x</td>
</tr>
<tr class="covered">
<td class="num">489</td>
<td class="src"><pre><code class="objc">    return psc;</code></pre></td>
<td class="coverage">11x</td>
</tr>
<tr class="covered">
<td class="num">490</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="never">
<td class="num">491</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">492</td>
<td class="src"><pre><code class="objc">+ (void)addPersistentStoreBackingUpCorruptedDatabases:(BOOL)backupCorruptedDatabase toPSC:(NSPersistentStoreCoordinator *)psc</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">493</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">11x</td>
</tr>
<tr class="covered">
<td class="num">494</td>
<td class="src"><pre><code class="objc">    // If we do not have a store by now, we are either already at the current version, or updating from a non E2EE build, or the migration failed.</code></pre></td>
<td class="coverage">11x</td>
</tr>
<tr class="covered">
<td class="num">495</td>
<td class="src"><pre><code class="objc">    // Either way we will try to create a persistent store without perfoming any migrations.</code></pre></td>
<td class="coverage">11x</td>
</tr>
<tr class="covered">
<td class="num">496</td>
<td class="src"><pre><code class="objc">    NSDictionary *options = [self persistentStoreOptionsDictionarySupportingMigration:NO];</code></pre></td>
<td class="coverage">11x</td>
</tr>
<tr class="covered">
<td class="num">497</td>
<td class="src"><pre><code class="objc">    NSError *error;</code></pre></td>
<td class="coverage">11x</td>
</tr>
<tr class="covered">
<td class="num">498</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">11x</td>
</tr>
<tr class="covered">
<td class="num">499</td>
<td class="src"><pre><code class="objc">    NSPersistentStore *store = [psc addPersistentStoreWithType:NSSQLiteStoreType configuration:nil URL:[self storeURL] options:options error:&amp;error];</code></pre></td>
<td class="coverage">11x</td>
</tr>
<tr class="covered">
<td class="num">500</td>
<td class="src"><pre><code class="objc">    if (store == nil) {</code></pre></td>
<td class="coverage">11x</td>
</tr>
<tr class="covered">
<td class="num">501</td>
<td class="src"><pre><code class="objc">        // Something really wrong</code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="covered">
<td class="num">502</td>
<td class="src"><pre><code class="objc">        // Try to remove the store and create from scratch</code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="covered">
<td class="num">503</td>
<td class="src"><pre><code class="objc">        if(backupCorruptedDatabase) {</code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="covered">
<td class="num">504</td>
<td class="src"><pre><code class="objc">            NSString *errorString = [NSString stringWithFormat:@"Error in opening database: %@", error];</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">505</td>
<td class="src"><pre><code class="objc">            dispatch_async(dispatch_get_main_queue(), ^{</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">506</td>
<td class="src"><pre><code class="objc">                UIAlertView *alert = [[UIAlertView alloc] initWithTitle:@"Database corruption" message:errorString delegate:nil cancelButtonTitle:@"Dismiss" otherButtonTitles:nil];</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">507</td>
<td class="src"><pre><code class="objc">                [alert show];</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">508</td>
<td class="src"><pre><code class="objc">            });</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">509</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">510</td>
<td class="src"><pre><code class="objc">        ZMLogError(@"Failed to open database. Corrupted database? Error: %@", error);</code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="covered">
<td class="num">511</td>
<td class="src"><pre><code class="objc">        </code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="covered">
<td class="num">512</td>
<td class="src"><pre><code class="objc">        [self removePersistentStoreFromFilesystemAndCopyToBackup:backupCorruptedDatabase];</code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="covered">
<td class="num">513</td>
<td class="src"><pre><code class="objc">        // Re-try to add the store</code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="covered">
<td class="num">514</td>
<td class="src"><pre><code class="objc">        store = [psc addPersistentStoreWithType:NSSQLiteStoreType configuration:nil URL:[self storeURL] options:options error:&amp;error];</code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="covered">
<td class="num">515</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="covered">
<td class="num">516</td>
<td class="src"><pre><code class="objc">    RequireString(store != nil, "Unable to create SQLite Core Data store: %lu", (long) error.code);</code></pre></td>
<td class="coverage">11x</td>
</tr>
<tr class="covered">
<td class="num">517</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">11x</td>
</tr>
<tr class="never">
<td class="num">518</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">519</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">520</td>
<td class="src"><pre><code class="objc">+ (NSDictionary *)persistentStoreOptionsDictionarySupportingMigration:(BOOL)supportsMigration</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">521</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">522</td>
<td class="src"><pre><code class="objc">    return @{</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">523</td>
<td class="src"><pre><code class="objc">             // https://www.sqlite.org/pragma.html</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">524</td>
<td class="src"><pre><code class="objc">             NSSQLitePragmasOption: @{ @"journal_mode": @"WAL", @"synchronous" : @"FULL" },</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">525</td>
<td class="src"><pre><code class="objc">             NSMigratePersistentStoresAutomaticallyOption: @(supportsMigration),</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">526</td>
<td class="src"><pre><code class="objc">             NSInferMappingModelAutomaticallyOption: @(supportsMigration)</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">527</td>
<td class="src"><pre><code class="objc">             };</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">528</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="never">
<td class="num">529</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">530</td>
<td class="src"><pre><code class="objc">+ (NSURL *)urlForDatabaseDirectoryInSearchPathDirectory:(NSSearchPathDirectory)searchPathDirectory</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">531</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">98x</td>
</tr>
<tr class="covered">
<td class="num">532</td>
<td class="src"><pre><code class="objc">    NSError *error;</code></pre></td>
<td class="coverage">98x</td>
</tr>
<tr class="covered">
<td class="num">533</td>
<td class="src"><pre><code class="objc">    NSFileManager *fm = [NSFileManager defaultManager];</code></pre></td>
<td class="coverage">98x</td>
</tr>
<tr class="covered">
<td class="num">534</td>
<td class="src"><pre><code class="objc">    NSURL * const directory = [fm URLForDirectory:searchPathDirectory inDomain:NSUserDomainMask appropriateForURL:nil create:YES error:&amp;error];</code></pre></td>
<td class="coverage">98x</td>
</tr>
<tr class="covered">
<td class="num">535</td>
<td class="src"><pre><code class="objc">    RequireString(directory != nil, "Failed to get or create directory: %lu", (long) error.code);</code></pre></td>
<td class="coverage">98x</td>
</tr>
<tr class="covered">
<td class="num">536</td>
<td class="src"><pre><code class="objc">    NSString *identifier = [NSBundle mainBundle].bundleIdentifier;</code></pre></td>
<td class="coverage">98x</td>
</tr>
<tr class="covered">
<td class="num">537</td>
<td class="src"><pre><code class="objc">    if (identifier == nil) {</code></pre></td>
<td class="coverage">98x</td>
</tr>
<tr class="missed">
<td class="num">538</td>
<td class="src"><pre><code class="objc">        identifier = ((NSBundle *)[NSBundle bundleForClass:[ZMUser class]]).bundleIdentifier;</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">539</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">540</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">98x</td>
</tr>
<tr class="covered">
<td class="num">541</td>
<td class="src"><pre><code class="objc">    return [directory URLByAppendingPathComponent:identifier];</code></pre></td>
<td class="coverage">98x</td>
</tr>
<tr class="covered">
<td class="num">542</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">98x</td>
</tr>
<tr class="never">
<td class="num">543</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">544</td>
<td class="src"><pre><code class="objc">+ (NSURL *)storeURLInDirectory:(NSSearchPathDirectory)directory;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">545</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">98x</td>
</tr>
<tr class="covered">
<td class="num">546</td>
<td class="src"><pre><code class="objc">    NSError *error;</code></pre></td>
<td class="coverage">98x</td>
</tr>
<tr class="covered">
<td class="num">547</td>
<td class="src"><pre><code class="objc">    NSURL *storeURL = [self urlForDatabaseDirectoryInSearchPathDirectory:directory];</code></pre></td>
<td class="coverage">98x</td>
</tr>
<tr class="covered">
<td class="num">548</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">98x</td>
</tr>
<tr class="covered">
<td class="num">549</td>
<td class="src"><pre><code class="objc">    NSFileManager *fm = [NSFileManager defaultManager];</code></pre></td>
<td class="coverage">98x</td>
</tr>
<tr class="covered">
<td class="num">550</td>
<td class="src"><pre><code class="objc">    if (! [fm fileExistsAtPath:storeURL.path]) {</code></pre></td>
<td class="coverage">98x</td>
</tr>
<tr class="covered">
<td class="num">551</td>
<td class="src"><pre><code class="objc">        short const permissions = 0700;</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">552</td>
<td class="src"><pre><code class="objc">        NSDictionary *attr = @{NSFilePosixPermissions: @(permissions)};</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">553</td>
<td class="src"><pre><code class="objc">        RequireString([fm createDirectoryAtURL:storeURL withIntermediateDirectories:YES attributes:attr error:&amp;error],</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">554</td>
<td class="src"><pre><code class="objc">                      "Failed to create subdirectory in searchpath directory: %lu, error: %lu", (unsigned long)directory,  (unsigned long) error.code);</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">555</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">556</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">98x</td>
</tr>
<tr class="covered">
<td class="num">557</td>
<td class="src"><pre><code class="objc">    // Make sure this is not backed up:</code></pre></td>
<td class="coverage">98x</td>
</tr>
<tr class="covered">
<td class="num">558</td>
<td class="src"><pre><code class="objc">    if (! [storeURL setResourceValue:@YES forKey:NSURLIsExcludedFromBackupKey error:&amp;error]) {</code></pre></td>
<td class="coverage">98x</td>
</tr>
<tr class="missed">
<td class="num">559</td>
<td class="src"><pre><code class="objc">        ZMLogError(@"Error excluding %@ from backup %@", storeURL.path, error);</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">560</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">561</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">98x</td>
</tr>
<tr class="covered">
<td class="num">562</td>
<td class="src"><pre><code class="objc">    NSString *storeFilename = @"store.wiredatabase";</code></pre></td>
<td class="coverage">98x</td>
</tr>
<tr class="covered">
<td class="num">563</td>
<td class="src"><pre><code class="objc">    return [storeURL URLByAppendingPathComponent:storeFilename];</code></pre></td>
<td class="coverage">98x</td>
</tr>
<tr class="covered">
<td class="num">564</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">98x</td>
</tr>
<tr class="never">
<td class="num">565</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">566</td>
<td class="src"><pre><code class="objc">+ (NSURL *)storeURL;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">567</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">42x</td>
</tr>
<tr class="covered">
<td class="num">568</td>
<td class="src"><pre><code class="objc">    return [self storeURLInDirectory:NSApplicationSupportDirectory];</code></pre></td>
<td class="coverage">42x</td>
</tr>
<tr class="covered">
<td class="num">569</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">42x</td>
</tr>
<tr class="never">
<td class="num">570</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">571</td>
<td class="src"><pre><code class="objc">+ (NSURL *)cachesDirectoryStoreURL;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">572</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">25x</td>
</tr>
<tr class="covered">
<td class="num">573</td>
<td class="src"><pre><code class="objc">    return [self storeURLInDirectory:NSCachesDirectory];</code></pre></td>
<td class="coverage">25x</td>
</tr>
<tr class="covered">
<td class="num">574</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">25x</td>
</tr>
<tr class="never">
<td class="num">575</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">576</td>
<td class="src"><pre><code class="objc">/// If this is false it means we have succesfully moved the database from the caches directory to the application support directory</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">577</td>
<td class="src"><pre><code class="objc">+ (BOOL)databaseExistsInCachesDirectory</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">578</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">23x</td>
</tr>
<tr class="covered">
<td class="num">579</td>
<td class="src"><pre><code class="objc">    NSFileManager *fm = [NSFileManager defaultManager];</code></pre></td>
<td class="coverage">23x</td>
</tr>
<tr class="covered">
<td class="num">580</td>
<td class="src"><pre><code class="objc">    NSURL *databaseURL = [self cachesDirectoryStoreURL];</code></pre></td>
<td class="coverage">23x</td>
</tr>
<tr class="covered">
<td class="num">581</td>
<td class="src"><pre><code class="objc">    BOOL fileExists = [fm fileExistsAtPath:databaseURL.path isDirectory:nil];</code></pre></td>
<td class="coverage">23x</td>
</tr>
<tr class="covered">
<td class="num">582</td>
<td class="src"><pre><code class="objc">    return fileExists;</code></pre></td>
<td class="coverage">23x</td>
</tr>
<tr class="covered">
<td class="num">583</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">23x</td>
</tr>
<tr class="never">
<td class="num">584</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">585</td>
<td class="src"><pre><code class="objc">/// Checks if database is created, but it is still locked with iOS file protection</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">586</td>
<td class="src"><pre><code class="objc">+ (BOOL)databaseExistsAndNotReadableDueToEncryption</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">587</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">17x</td>
</tr>
<tr class="covered">
<td class="num">588</td>
<td class="src"><pre><code class="objc">    NSFileManager *fm = [NSFileManager defaultManager];</code></pre></td>
<td class="coverage">17x</td>
</tr>
<tr class="covered">
<td class="num">589</td>
<td class="src"><pre><code class="objc">    NSURL *databaseURL = [self storeURL];</code></pre></td>
<td class="coverage">17x</td>
</tr>
<tr class="covered">
<td class="num">590</td>
<td class="src"><pre><code class="objc">    BOOL fileExists = [fm fileExistsAtPath:databaseURL.path isDirectory:nil];</code></pre></td>
<td class="coverage">17x</td>
</tr>
<tr class="covered">
<td class="num">591</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">17x</td>
</tr>
<tr class="covered">
<td class="num">592</td>
<td class="src"><pre><code class="objc">    NSError *readError = nil;</code></pre></td>
<td class="coverage">17x</td>
</tr>
<tr class="covered">
<td class="num">593</td>
<td class="src"><pre><code class="objc">    [NSFileHandle fileHandleForReadingFromURL:databaseURL error:&amp;readError];</code></pre></td>
<td class="coverage">17x</td>
</tr>
<tr class="covered">
<td class="num">594</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">17x</td>
</tr>
<tr class="covered">
<td class="num">595</td>
<td class="src"><pre><code class="objc">    BOOL result = fileExists &amp;&amp; readError != nil;</code></pre></td>
<td class="coverage">14x</td>
</tr>
<tr class="covered">
<td class="num">596</td>
<td class="src"><pre><code class="objc">    if (result) {</code></pre></td>
<td class="coverage">17x</td>
</tr>
<tr class="missed">
<td class="num">597</td>
<td class="src"><pre><code class="objc">        ZMLogError(@"databaseExistsAndNotReadableDueToEncryption=true, error=%@", readError);</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">598</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">599</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">17x</td>
</tr>
<tr class="covered">
<td class="num">600</td>
<td class="src"><pre><code class="objc">    return result;</code></pre></td>
<td class="coverage">17x</td>
</tr>
<tr class="covered">
<td class="num">601</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">17x</td>
</tr>
<tr class="never">
<td class="num">602</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">603</td>
<td class="src"><pre><code class="objc">+ (BOOL)moveDatabaseFromCachesToApplicationSupportIfNeeded</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">604</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">605</td>
<td class="src"><pre><code class="objc">    // we need to move if true</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">606</td>
<td class="src"><pre><code class="objc">    if ([self databaseExistsInCachesDirectory]) {</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">607</td>
<td class="src"><pre><code class="objc">        </code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">608</td>
<td class="src"><pre><code class="objc">        NSError *error;</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">609</td>
<td class="src"><pre><code class="objc">        NSURL *toURL   = [self storeURL];</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">610</td>
<td class="src"><pre><code class="objc">        NSURL *fromURL = [self cachesDirectoryStoreURL];</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">611</td>
<td class="src"><pre><code class="objc">        NSFileManager *fm = [NSFileManager defaultManager];</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">612</td>
<td class="src"><pre><code class="objc">        </code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">613</td>
<td class="src"><pre><code class="objc">        ZMLogDebug(@"Starting to move database from path: %@ to path: %@", fromURL, toURL);</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">614</td>
<td class="src"><pre><code class="objc">        </code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">615</td>
<td class="src"><pre><code class="objc">        for (NSString *extension in self.databaseFileExtensions) {</code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="covered">
<td class="num">616</td>
<td class="src"><pre><code class="objc">            </code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="covered">
<td class="num">617</td>
<td class="src"><pre><code class="objc">            NSString *destinationPath = [toURL.path stringByAppendingString:extension];</code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="covered">
<td class="num">618</td>
<td class="src"><pre><code class="objc">            NSString *sourcePath = [fromURL.path stringByAppendingString:extension];</code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="covered">
<td class="num">619</td>
<td class="src"><pre><code class="objc">            </code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="covered">
<td class="num">620</td>
<td class="src"><pre><code class="objc">            if (! [fm fileExistsAtPath:sourcePath isDirectory:nil]) {</code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="missed">
<td class="num">621</td>
<td class="src"><pre><code class="objc">                continue;</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">622</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">623</td>
<td class="src"><pre><code class="objc">            </code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="covered">
<td class="num">624</td>
<td class="src"><pre><code class="objc">            if (! [fm moveItemAtPath:sourcePath toPath:destinationPath error:&amp;error]) {</code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="missed">
<td class="num">625</td>
<td class="src"><pre><code class="objc">                ZMLogError(@"Failed to copy database from caches: %@ to application support directory: %@ error: %@", sourcePath, destinationPath, error);</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">626</td>
<td class="src"><pre><code class="objc">                return NO;</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">627</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">628</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="covered">
<td class="num">629</td>
<td class="src"><pre><code class="objc">        </code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">630</td>
<td class="src"><pre><code class="objc">        [self moveExternalBinaryFilesFromCachesToApplicationSupport];</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">631</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">632</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">633</td>
<td class="src"><pre><code class="objc">    return YES;</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="covered">
<td class="num">634</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">19x</td>
</tr>
<tr class="never">
<td class="num">635</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">636</td>
<td class="src"><pre><code class="objc">+ (void)moveExternalBinaryFilesFromCachesToApplicationSupport;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">637</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">638</td>
<td class="src"><pre><code class="objc">    NSURL *const cachesURL = [self cachesDirectoryStoreURL];</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">639</td>
<td class="src"><pre><code class="objc">    NSString * const storeName = [cachesURL.URLByDeletingPathExtension lastPathComponent];</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">640</td>
<td class="src"><pre><code class="objc">    NSURL *parentURL = cachesURL.URLByDeletingLastPathComponent;</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">641</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">642</td>
<td class="src"><pre><code class="objc">    NSFileManager *fm = [NSFileManager defaultManager];</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">643</td>
<td class="src"><pre><code class="objc">    BOOL isDirectory = NO;</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">644</td>
<td class="src"><pre><code class="objc">    if (![fm fileExistsAtPath:parentURL.path isDirectory:&amp;isDirectory] || !isDirectory) {</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="missed">
<td class="num">645</td>
<td class="src"><pre><code class="objc">        return;</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">646</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">647</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">648</td>
<td class="src"><pre><code class="objc">    NSURL *toURLParent = [self storeURL].URLByDeletingLastPathComponent;</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">649</td>
<td class="src"><pre><code class="objc">    NSString *supportExtension = [NSString stringWithFormat:@".%@_SUPPORT", storeName];</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">650</td>
<td class="src"><pre><code class="objc">    NSURL *fromURL = [parentURL URLByAppendingPathComponent:supportExtension];</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">651</td>
<td class="src"><pre><code class="objc">    NSURL *toURL = [toURLParent URLByAppendingPathComponent:supportExtension];</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">652</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">653</td>
<td class="src"><pre><code class="objc">    if ([fm fileExistsAtPath:fromURL.path]) {</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">654</td>
<td class="src"><pre><code class="objc">        NSError *error = nil;</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">655</td>
<td class="src"><pre><code class="objc">        if (! [fm moveItemAtURL:fromURL toURL:toURL error:&amp;error]) {</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="missed">
<td class="num">656</td>
<td class="src"><pre><code class="objc">            ZMLogError(@"Unable to move external binary data item from: %@ to: %@", fromURL.path, error);</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">657</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">658</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">659</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="never">
<td class="num">660</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">661</td>
<td class="src"><pre><code class="objc">+ (NSArray &lt;NSString *&gt; *)databaseFileExtensions</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">662</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">663</td>
<td class="src"><pre><code class="objc">    return @[@"", @"-wal", @"-shm"];</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">664</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="never">
<td class="num">665</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">666</td>
<td class="src"><pre><code class="objc">- (BOOL)saveOrRollback;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">667</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">5770x</td>
</tr>
<tr class="covered">
<td class="num">668</td>
<td class="src"><pre><code class="objc">    return [self saveOrRollbackIgnoringChanges:NO];</code></pre></td>
<td class="coverage">5770x</td>
</tr>
<tr class="covered">
<td class="num">669</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">5770x</td>
</tr>
<tr class="never">
<td class="num">670</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">671</td>
<td class="src"><pre><code class="objc">- (BOOL)forceSaveOrRollback;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="missed">
<td class="num">672</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">673</td>
<td class="src"><pre><code class="objc">    return [self saveOrRollbackIgnoringChanges:YES];</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">674</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="never">
<td class="num">675</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">676</td>
<td class="src"><pre><code class="objc">- (BOOL)saveOrRollbackIgnoringChanges:(BOOL)shouldIgnoreChanges;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">677</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">5770x</td>
</tr>
<tr class="covered">
<td class="num">678</td>
<td class="src"><pre><code class="objc">    if(self.userInfo[IsSaveDisabled]) {</code></pre></td>
<td class="coverage">5770x</td>
</tr>
<tr class="missed">
<td class="num">679</td>
<td class="src"><pre><code class="objc">        return YES;</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">680</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">681</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">5770x</td>
</tr>
<tr class="covered">
<td class="num">682</td>
<td class="src"><pre><code class="objc">    ZMLogDebug(@"%@ &lt;%@: %p&gt;.", NSStringFromSelector(_cmd), self.class, self);</code></pre></td>
<td class="coverage">5770x</td>
</tr>
<tr class="covered">
<td class="num">683</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">5770x</td>
</tr>
<tr class="covered">
<td class="num">684</td>
<td class="src"><pre><code class="objc">    NSDictionary *oldMetadata = [self.persistentStoreCoordinator metadataForPersistentStore:[self firstPersistentStore]];</code></pre></td>
<td class="coverage">5770x</td>
</tr>
<tr class="covered">
<td class="num">685</td>
<td class="src"><pre><code class="objc">    [self makeMetadataPersistent];</code></pre></td>
<td class="coverage">5770x</td>
</tr>
<tr class="covered">
<td class="num">686</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">5770x</td>
</tr>
<tr class="covered">
<td class="num">687</td>
<td class="src"><pre><code class="objc">    if (self.userInfo[IsFailingToSave]) {</code></pre></td>
<td class="coverage">5770x</td>
</tr>
<tr class="covered">
<td class="num">688</td>
<td class="src"><pre><code class="objc">        [self rollbackWithOldMetadata:oldMetadata];</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">689</td>
<td class="src"><pre><code class="objc">        return NO;</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">690</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">691</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">5770x</td>
</tr>
<tr class="covered">
<td class="num">692</td>
<td class="src"><pre><code class="objc">    // We need to save even if hasChanges is NO as long as the callState changes. An empty save will result in an empty did-save notification.</code></pre></td>
<td class="coverage">5770x</td>
</tr>
<tr class="covered">
<td class="num">693</td>
<td class="src"><pre><code class="objc">    // That notification in turn will result in a merge, even if it is empty, and thus merge the call state.</code></pre></td>
<td class="coverage">5770x</td>
</tr>
<tr class="covered">
<td class="num">694</td>
<td class="src"><pre><code class="objc">    if (self.zm_hasChanges || shouldIgnoreChanges) {</code></pre></td>
<td class="coverage">5770x</td>
</tr>
<tr class="covered">
<td class="num">695</td>
<td class="src"><pre><code class="objc">        NSError *error;</code></pre></td>
<td class="coverage">2720x</td>
</tr>
<tr class="covered">
<td class="num">696</td>
<td class="src"><pre><code class="objc">        ZMLogDebug(@"Saving &lt;%@: %p&gt;.", self.class, self);</code></pre></td>
<td class="coverage">2720x</td>
</tr>
<tr class="covered">
<td class="num">697</td>
<td class="src"><pre><code class="objc">        self.timeOfLastSave = [NSDate date];</code></pre></td>
<td class="coverage">2720x</td>
</tr>
<tr class="covered">
<td class="num">698</td>
<td class="src"><pre><code class="objc">        ZMSTimePoint *tp = [ZMSTimePoint timePointWithInterval:10 label:[NSString stringWithFormat:@"Saving context %@", self.zm_isSyncContext ? @"sync": @"ui"]];</code></pre></td>
<td class="coverage">2720x</td>
</tr>
<tr class="covered">
<td class="num">699</td>
<td class="src"><pre><code class="objc">        if (! [self save:&amp;error]) {</code></pre></td>
<td class="coverage">2720x</td>
</tr>
<tr class="covered">
<td class="num">700</td>
<td class="src"><pre><code class="objc">            ZMLogError(@"Failed to save: %@", error);</code></pre></td>
<td class="coverage">37x</td>
</tr>
<tr class="covered">
<td class="num">701</td>
<td class="src"><pre><code class="objc">            [self rollbackWithOldMetadata:oldMetadata];</code></pre></td>
<td class="coverage">37x</td>
</tr>
<tr class="covered">
<td class="num">702</td>
<td class="src"><pre><code class="objc">            [tp warnIfLongerThanInterval];</code></pre></td>
<td class="coverage">37x</td>
</tr>
<tr class="covered">
<td class="num">703</td>
<td class="src"><pre><code class="objc">            return NO;</code></pre></td>
<td class="coverage">37x</td>
</tr>
<tr class="covered">
<td class="num">704</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">37x</td>
</tr>
<tr class="covered">
<td class="num">705</td>
<td class="src"><pre><code class="objc">        [tp warnIfLongerThanInterval];</code></pre></td>
<td class="coverage">2680x</td>
</tr>
<tr class="covered">
<td class="num">706</td>
<td class="src"><pre><code class="objc">        [self refreshUnneededObjects];</code></pre></td>
<td class="coverage">2680x</td>
</tr>
<tr class="covered">
<td class="num">707</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">2680x</td>
</tr>
<tr class="covered">
<td class="num">708</td>
<td class="src"><pre><code class="objc">    else {</code></pre></td>
<td class="coverage">3040x</td>
</tr>
<tr class="covered">
<td class="num">709</td>
<td class="src"><pre><code class="objc">        ZMLogDebug(@"Not saving because there is no change");</code></pre></td>
<td class="coverage">3040x</td>
</tr>
<tr class="covered">
<td class="num">710</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">3040x</td>
</tr>
<tr class="covered">
<td class="num">711</td>
<td class="src"><pre><code class="objc">    return YES;</code></pre></td>
<td class="coverage">5730x</td>
</tr>
<tr class="covered">
<td class="num">712</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">5770x</td>
</tr>
<tr class="never">
<td class="num">713</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">714</td>
<td class="src"><pre><code class="objc">- (void)rollbackWithOldMetadata:(NSDictionary *)oldMetadata;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">715</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">38x</td>
</tr>
<tr class="covered">
<td class="num">716</td>
<td class="src"><pre><code class="objc">    [self rollback];</code></pre></td>
<td class="coverage">38x</td>
</tr>
<tr class="covered">
<td class="num">717</td>
<td class="src"><pre><code class="objc">    [self.persistentStoreCoordinator setMetadata:oldMetadata forPersistentStore:[self firstPersistentStore]];</code></pre></td>
<td class="coverage">38x</td>
</tr>
<tr class="covered">
<td class="num">718</td>
<td class="src"><pre><code class="objc">    if (self.zm_isSyncContext) {</code></pre></td>
<td class="coverage">38x</td>
</tr>
<tr class="covered">
<td class="num">719</td>
<td class="src"><pre><code class="objc">        [self.zm_cryptKeyStore.box resetSessionsRequiringSave];</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">720</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">721</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">38x</td>
</tr>
<tr class="never">
<td class="num">722</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">723</td>
<td class="src"><pre><code class="objc">- (NSDate *)timeOfLastSave;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">724</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">70x</td>
</tr>
<tr class="covered">
<td class="num">725</td>
<td class="src"><pre><code class="objc">    return self.userInfo[TimeOfLastSaveKey];</code></pre></td>
<td class="coverage">70x</td>
</tr>
<tr class="covered">
<td class="num">726</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">70x</td>
</tr>
<tr class="never">
<td class="num">727</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">728</td>
<td class="src"><pre><code class="objc">- (void)setTimeOfLastSave:(NSDate *)date;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">729</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">2720x</td>
</tr>
<tr class="covered">
<td class="num">730</td>
<td class="src"><pre><code class="objc">    if (date != nil) {</code></pre></td>
<td class="coverage">2720x</td>
</tr>
<tr class="covered">
<td class="num">731</td>
<td class="src"><pre><code class="objc">        self.userInfo[TimeOfLastSaveKey] = date;</code></pre></td>
<td class="coverage">2720x</td>
</tr>
<tr class="missed">
<td class="num">732</td>
<td class="src"><pre><code class="objc">    } else {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">733</td>
<td class="src"><pre><code class="objc">        [self.userInfo removeObjectForKey:TimeOfLastSaveKey];</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">734</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">735</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">2720x</td>
</tr>
<tr class="never">
<td class="num">736</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">737</td>
<td class="src"><pre><code class="objc">- (NSDate *)firstEnqueuedSave {</code></pre></td>
<td class="coverage">65x</td>
</tr>
<tr class="covered">
<td class="num">738</td>
<td class="src"><pre><code class="objc">    return self.userInfo[FirstEnqueuedSaveKey];</code></pre></td>
<td class="coverage">65x</td>
</tr>
<tr class="covered">
<td class="num">739</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">65x</td>
</tr>
<tr class="never">
<td class="num">740</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">741</td>
<td class="src"><pre><code class="objc">- (void)setFirstEnqueuedSave:(NSDate *)date;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">742</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">5x</td>
</tr>
<tr class="covered">
<td class="num">743</td>
<td class="src"><pre><code class="objc">    if (date != nil) {</code></pre></td>
<td class="coverage">5x</td>
</tr>
<tr class="covered">
<td class="num">744</td>
<td class="src"><pre><code class="objc">        self.userInfo[FirstEnqueuedSaveKey] = date;</code></pre></td>
<td class="coverage">5x</td>
</tr>
<tr class="missed">
<td class="num">745</td>
<td class="src"><pre><code class="objc">    } else {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">746</td>
<td class="src"><pre><code class="objc">        [self.userInfo removeObjectForKey:FirstEnqueuedSaveKey];</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">747</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">748</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">5x</td>
</tr>
<tr class="never">
<td class="num">749</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">750</td>
<td class="src"><pre><code class="objc">- (void)enqueueDelayedSave;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">751</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">32x</td>
</tr>
<tr class="covered">
<td class="num">752</td>
<td class="src"><pre><code class="objc">    [self enqueueDelayedSaveWithGroup:nil];</code></pre></td>
<td class="coverage">32x</td>
</tr>
<tr class="covered">
<td class="num">753</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">32x</td>
</tr>
<tr class="never">
<td class="num">754</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">755</td>
<td class="src"><pre><code class="objc">- (BOOL)saveIfTooManyChanges</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">756</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">757</td>
<td class="src"><pre><code class="objc">    NSUInteger const changeCount = self.deletedObjects.count + self.insertedObjects.count + self.updatedObjects.count;</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">758</td>
<td class="src"><pre><code class="objc">    NSUInteger const threshold = 200;</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">759</td>
<td class="src"><pre><code class="objc">    if (threshold &lt; changeCount) {</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="missed">
<td class="num">760</td>
<td class="src"><pre><code class="objc">        ZMLogDebug(@"enqueueSaveIfTooManyChanges: calling -saveOrRollback synchronuously because change count is %llu.", (unsigned long long) changeCount);</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">761</td>
<td class="src"><pre><code class="objc">        [self saveOrRollback];</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">762</td>
<td class="src"><pre><code class="objc">        return YES;</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">763</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">764</td>
<td class="src"><pre><code class="objc">    return NO;</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">765</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="never">
<td class="num">766</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">767</td>
<td class="src"><pre><code class="objc">- (BOOL)saveIfDelayIsTooLong</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">768</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">769</td>
<td class="src"><pre><code class="objc">    if (self.firstEnqueuedSave == nil) {</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">770</td>
<td class="src"><pre><code class="objc">        self.firstEnqueuedSave = [NSDate date];</code></pre></td>
<td class="coverage">5x</td>
</tr>
<tr class="covered">
<td class="num">771</td>
<td class="src"><pre><code class="objc">    } else {</code></pre></td>
<td class="coverage">30x</td>
</tr>
<tr class="covered">
<td class="num">772</td>
<td class="src"><pre><code class="objc">        if ([[NSDate date] timeIntervalSinceDate:self.firstEnqueuedSave] &gt; 0.25) {</code></pre></td>
<td class="coverage">30x</td>
</tr>
<tr class="missed">
<td class="num">773</td>
<td class="src"><pre><code class="objc">            [self saveOrRollback];</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">774</td>
<td class="src"><pre><code class="objc">            self.firstEnqueuedSave = nil;</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">775</td>
<td class="src"><pre><code class="objc">            return YES;</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">776</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">777</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">30x</td>
</tr>
<tr class="covered">
<td class="num">778</td>
<td class="src"><pre><code class="objc">    return NO;</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">779</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="never">
<td class="num">780</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">781</td>
<td class="src"><pre><code class="objc">- (void)enqueueDelayedSaveWithGroup:(ZMSDispatchGroup *)group;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">782</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">783</td>
<td class="src"><pre><code class="objc">    if(self.userInfo[IsSaveDisabled]) {</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="missed">
<td class="num">784</td>
<td class="src"><pre><code class="objc">        return;</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">785</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">786</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">787</td>
<td class="src"><pre><code class="objc">    if ([self saveIfTooManyChanges] ||</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">788</td>
<td class="src"><pre><code class="objc">        [self saveIfDelayIsTooLong])</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="missed">
<td class="num">789</td>
<td class="src"><pre><code class="objc">    {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">790</td>
<td class="src"><pre><code class="objc">        return;</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">791</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">792</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">793</td>
<td class="src"><pre><code class="objc">    // Delay function (not to scale):</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">794</td>
<td class="src"><pre><code class="objc">    //       ^</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">795</td>
<td class="src"><pre><code class="objc">    //       &#65533;&#65533;&#65533;</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">796</td>
<td class="src"><pre><code class="objc">    //  0.100&#65533;&#65533;&#65533;\</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">797</td>
<td class="src"><pre><code class="objc">    //       &#65533;&#65533;&#65533;  \</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">798</td>
<td class="src"><pre><code class="objc">    //       &#65533;&#65533;&#65533;    \</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">799</td>
<td class="src"><pre><code class="objc">    //       &#65533;&#65533;&#65533;      \</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">800</td>
<td class="src"><pre><code class="objc">    // delay &#65533;&#65533;&#65533;        \</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">801</td>
<td class="src"><pre><code class="objc">    //       &#65533;&#65533;&#65533;          \</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">802</td>
<td class="src"><pre><code class="objc">    //       &#65533;&#65533;&#65533;            \</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">803</td>
<td class="src"><pre><code class="objc">    //  0.002&#65533;&#65533;&#65533;              +------------------</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">804</td>
<td class="src"><pre><code class="objc">    //       &#65533;&#65533;&#65533;              :</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">805</td>
<td class="src"><pre><code class="objc">    //       +&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&#65533;&gt;</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">806</td>
<td class="src"><pre><code class="objc">    //       0              1s</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">807</td>
<td class="src"><pre><code class="objc">    //            time since last save</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">808</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">809</td>
<td class="src"><pre><code class="objc">    const double delta_s = (self.timeOfLastSave != nil) ? (-[self.timeOfLastSave timeIntervalSinceNow]) : 10000;</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">810</td>
<td class="src"><pre><code class="objc">    const double delay_s = (delta_s &gt; 0.98) ? 0.002 : (-0.1*delta_s + 0.1);</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">811</td>
<td class="src"><pre><code class="objc">    const unsigned int delay_ms = (unsigned int) lround(delay_s*1000);</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">812</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">813</td>
<td class="src"><pre><code class="objc">    // Grab a unique number, for debugging only:</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">814</td>
<td class="src"><pre><code class="objc">    static int32_t c;</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">815</td>
<td class="src"><pre><code class="objc">    int32_t myCount = ++c;</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">816</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">817</td>
<td class="src"><pre><code class="objc">    ZMLogDebug(@"enqueueDelayedSaveWithGroup: called (%d)", myCount);</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">818</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">819</td>
<td class="src"><pre><code class="objc">    // This code is a bit daunting at first. There are a total of 3 groups:</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">820</td>
<td class="src"><pre><code class="objc">    //</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">821</td>
<td class="src"><pre><code class="objc">    // otherGroups: This keeps track of "the context is doing some work" INCLUDING delayed save</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">822</td>
<td class="src"><pre><code class="objc">    // secondaryGroup: This keeps track of "the context is doing some work" EXCLUDING delayed save</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">823</td>
<td class="src"><pre><code class="objc">    // group: Passed in group</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">824</td>
<td class="src"><pre><code class="objc">    //</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">825</td>
<td class="src"><pre><code class="objc">    // (1) We'll enter all groups.</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">826</td>
<td class="src"><pre><code class="objc">    //</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">827</td>
<td class="src"><pre><code class="objc">    // (2) We increment the pendingSaveCounter</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">828</td>
<td class="src"><pre><code class="objc">    //</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">829</td>
<td class="src"><pre><code class="objc">    // (2) After a tiny time interval, we'll leave the secondary group. Since calls to -performGroupedBlock:</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">830</td>
<td class="src"><pre><code class="objc">    //     also get added to this group, we can use</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">831</td>
<td class="src"><pre><code class="objc">    //         dispatch_group_notify(secondaryGroup, ...)</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">832</td>
<td class="src"><pre><code class="objc">    //     to know that no further work is scheduled on this context. At that point we decrement pendingSaveCounter.</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">833</td>
<td class="src"><pre><code class="objc">    //</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">834</td>
<td class="src"><pre><code class="objc">    // (3) If pendingSaveCounter is 0 at this point (no outstanding saves), we perform the actual save.</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">835</td>
<td class="src"><pre><code class="objc">    //</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">836</td>
<td class="src"><pre><code class="objc">    // The pendingSaveCounter ensures that only the last enqueued save will perform the actual save, ie. it's</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">837</td>
<td class="src"><pre><code class="objc">    // safe and efficient to call this method multiple times.</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">838</td>
<td class="src"><pre><code class="objc">    //</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">839</td>
<td class="src"><pre><code class="objc">    //     work -&gt; enqueueSave -&gt; work -&gt; enqueueSave -&gt; work -&gt; enqueueSave</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">840</td>
<td class="src"><pre><code class="objc">    //                                                                      \--&gt; save at this point</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">841</td>
<td class="src"><pre><code class="objc">    //</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">842</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">843</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">844</td>
<td class="src"><pre><code class="objc">    // Enter all groups:</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">845</td>
<td class="src"><pre><code class="objc">    if (group) {</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">846</td>
<td class="src"><pre><code class="objc">        [group enter];</code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="covered">
<td class="num">847</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="covered">
<td class="num">848</td>
<td class="src"><pre><code class="objc">    ZMSDispatchGroup *secondaryGroup;</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">849</td>
<td class="src"><pre><code class="objc">    NSArray *otherGroups;</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">850</td>
<td class="src"><pre><code class="objc">    {</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">851</td>
<td class="src"><pre><code class="objc">        NSArray *groups = [self enterAllGroups];</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">852</td>
<td class="src"><pre><code class="objc">        secondaryGroup = groups[1];</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">853</td>
<td class="src"><pre><code class="objc">        NSMutableIndexSet *otherIndexes = [NSMutableIndexSet indexSetWithIndexesInRange:NSMakeRange(0, groups.count)];</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">854</td>
<td class="src"><pre><code class="objc">        [otherIndexes removeIndex:1];</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">855</td>
<td class="src"><pre><code class="objc">        otherGroups = [groups objectsAtIndexes:otherIndexes];</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">856</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">857</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">858</td>
<td class="src"><pre><code class="objc">    ++self.pendingSaveCounter;</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">859</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">860</td>
<td class="src"><pre><code class="objc">    // We'll wait just a little bit, just in case the group empties for a short span of time.</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">861</td>
<td class="src"><pre><code class="objc">    {</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">862</td>
<td class="src"><pre><code class="objc">        ZMLogDebug(@"dispatch_after() entered (%d)", myCount);</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">863</td>
<td class="src"><pre><code class="objc">        dispatch_time_t when = dispatch_walltime(NULL, delay_ms * NSEC_PER_MSEC);</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">864</td>
<td class="src"><pre><code class="objc">        dispatch_queue_t waitQueue = (ZMHasQualityOfServiceSupport() ?</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">865</td>
<td class="src"><pre><code class="objc">                                      dispatch_get_global_queue(QOS_CLASS_UTILITY, 0) :</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="missed">
<td class="num">866</td>
<td class="src"><pre><code class="objc">                                      dispatch_get_global_queue(0, 0));</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">867</td>
<td class="src"><pre><code class="objc">        dispatch_after(when, waitQueue, ^{</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">868</td>
<td class="src"><pre><code class="objc">            [secondaryGroup leave];</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">869</td>
<td class="src"><pre><code class="objc">            ZMLogDebug(@"dispatch_after() completed (%d)", myCount);</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">870</td>
<td class="src"><pre><code class="objc">        });</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">871</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">872</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">873</td>
<td class="src"><pre><code class="objc">    // Once the save group is empty (no pending saves), we'll do the actual save:</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">874</td>
<td class="src"><pre><code class="objc">    [secondaryGroup notifyOnQueue:dispatch_get_global_queue(0, 0) block:^{</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">875</td>
<td class="src"><pre><code class="objc">        [self performGroupedBlock:^{</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">876</td>
<td class="src"><pre><code class="objc">            NSInteger const c2 = --self.pendingSaveCounter;</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">877</td>
<td class="src"><pre><code class="objc">            if (c2 == 0) {</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">878</td>
<td class="src"><pre><code class="objc">                ZMLogDebug(@"Calling -saveOrRollback (%d)", myCount);</code></pre></td>
<td class="coverage">24x</td>
</tr>
<tr class="covered">
<td class="num">879</td>
<td class="src"><pre><code class="objc">                [self saveOrRollback];</code></pre></td>
<td class="coverage">24x</td>
</tr>
<tr class="covered">
<td class="num">880</td>
<td class="src"><pre><code class="objc">            } else {</code></pre></td>
<td class="coverage">11x</td>
</tr>
<tr class="covered">
<td class="num">881</td>
<td class="src"><pre><code class="objc">                ZMLogDebug(@"Not calling -saveOrRollback (%d)", myCount);</code></pre></td>
<td class="coverage">11x</td>
</tr>
<tr class="covered">
<td class="num">882</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">11x</td>
</tr>
<tr class="covered">
<td class="num">883</td>
<td class="src"><pre><code class="objc">            if (group) {</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">884</td>
<td class="src"><pre><code class="objc">                [group leave];</code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="covered">
<td class="num">885</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">3x</td>
</tr>
<tr class="covered">
<td class="num">886</td>
<td class="src"><pre><code class="objc">            [self leaveAllGroups:otherGroups];</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">887</td>
<td class="src"><pre><code class="objc">        }];</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">888</td>
<td class="src"><pre><code class="objc">    }];</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="covered">
<td class="num">889</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">35x</td>
</tr>
<tr class="never">
<td class="num">890</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">891</td>
<td class="src"><pre><code class="objc">- (void)ensureSingletonsExist;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">892</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">4420x</td>
</tr>
<tr class="covered">
<td class="num">893</td>
<td class="src"><pre><code class="objc">    static OSSpinLock lock = OS_SPINLOCK_INIT;</code></pre></td>
<td class="coverage">4420x</td>
</tr>
<tr class="covered">
<td class="num">894</td>
<td class="src"><pre><code class="objc">    [self performGroupedBlock:^{</code></pre></td>
<td class="coverage">4420x</td>
</tr>
<tr class="covered">
<td class="num">895</td>
<td class="src"><pre><code class="objc">        OSSpinLockLock(&amp;lock);</code></pre></td>
<td class="coverage">4420x</td>
</tr>
<tr class="covered">
<td class="num">896</td>
<td class="src"><pre><code class="objc">        [ZMUser selfUserInContext:self];</code></pre></td>
<td class="coverage">4420x</td>
</tr>
<tr class="covered">
<td class="num">897</td>
<td class="src"><pre><code class="objc">        OSSpinLockUnlock(&amp;lock);</code></pre></td>
<td class="coverage">4420x</td>
</tr>
<tr class="covered">
<td class="num">898</td>
<td class="src"><pre><code class="objc">    }];</code></pre></td>
<td class="coverage">4420x</td>
</tr>
<tr class="covered">
<td class="num">899</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">4420x</td>
</tr>
<tr class="never">
<td class="num">900</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">901</td>
<td class="src"><pre><code class="objc">- (NSMutableDictionary *)metadataInfo;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">902</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">13400x</td>
</tr>
<tr class="covered">
<td class="num">903</td>
<td class="src"><pre><code class="objc">    NSMutableDictionary *metadataInfo = self.userInfo[MetadataKey];</code></pre></td>
<td class="coverage">13400x</td>
</tr>
<tr class="covered">
<td class="num">904</td>
<td class="src"><pre><code class="objc">    if (!metadataInfo) {</code></pre></td>
<td class="coverage">13400x</td>
</tr>
<tr class="covered">
<td class="num">905</td>
<td class="src"><pre><code class="objc">        metadataInfo = [NSMutableDictionary dictionary];</code></pre></td>
<td class="coverage">4840x</td>
</tr>
<tr class="covered">
<td class="num">906</td>
<td class="src"><pre><code class="objc">        self.userInfo[MetadataKey] = metadataInfo;</code></pre></td>
<td class="coverage">4840x</td>
</tr>
<tr class="covered">
<td class="num">907</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">4840x</td>
</tr>
<tr class="covered">
<td class="num">908</td>
<td class="src"><pre><code class="objc">    return metadataInfo;</code></pre></td>
<td class="coverage">13400x</td>
</tr>
<tr class="covered">
<td class="num">909</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">13400x</td>
</tr>
<tr class="never">
<td class="num">910</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">911</td>
<td class="src"><pre><code class="objc">- (void)makeMetadataPersistent;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">912</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">5770x</td>
</tr>
<tr class="covered">
<td class="num">913</td>
<td class="src"><pre><code class="objc">    NSDictionary *metadata = self.userInfo[MetadataKey];</code></pre></td>
<td class="coverage">5770x</td>
</tr>
<tr class="covered">
<td class="num">914</td>
<td class="src"><pre><code class="objc">    if (nil != metadata) {</code></pre></td>
<td class="coverage">5770x</td>
</tr>
<tr class="covered">
<td class="num">915</td>
<td class="src"><pre><code class="objc">        NSMutableDictionary *newStoredMetadata = [[self.persistentStoreCoordinator metadataForPersistentStore:[self firstPersistentStore]] mutableCopy];</code></pre></td>
<td class="coverage">3160x</td>
</tr>
<tr class="covered">
<td class="num">916</td>
<td class="src"><pre><code class="objc">        </code></pre></td>
<td class="coverage">3160x</td>
</tr>
<tr class="covered">
<td class="num">917</td>
<td class="src"><pre><code class="objc">        [metadata enumerateKeysAndObjectsUsingBlock:^(id  _Nonnull key, id  _Nonnull obj, BOOL * _Nonnull stop ZM_UNUSED)</code></pre></td>
<td class="coverage">3160x</td>
</tr>
<tr class="covered">
<td class="num">918</td>
<td class="src"><pre><code class="objc">        {</code></pre></td>
<td class="coverage">4570x</td>
</tr>
<tr class="covered">
<td class="num">919</td>
<td class="src"><pre><code class="objc">            if ([obj isKindOfClass:[NSNull class]]) {</code></pre></td>
<td class="coverage">4570x</td>
</tr>
<tr class="covered">
<td class="num">920</td>
<td class="src"><pre><code class="objc">                [newStoredMetadata removeObjectForKey:key];</code></pre></td>
<td class="coverage">2940x</td>
</tr>
<tr class="covered">
<td class="num">921</td>
<td class="src"><pre><code class="objc">            } else if (obj) {</code></pre></td>
<td class="coverage">1630x</td>
</tr>
<tr class="covered">
<td class="num">922</td>
<td class="src"><pre><code class="objc">                newStoredMetadata[key] = obj;</code></pre></td>
<td class="coverage">1630x</td>
</tr>
<tr class="covered">
<td class="num">923</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">1630x</td>
</tr>
<tr class="covered">
<td class="num">924</td>
<td class="src"><pre><code class="objc">        }];</code></pre></td>
<td class="coverage">4570x</td>
</tr>
<tr class="covered">
<td class="num">925</td>
<td class="src"><pre><code class="objc">        [self.persistentStoreCoordinator setMetadata:newStoredMetadata forPersistentStore:[self firstPersistentStore]];</code></pre></td>
<td class="coverage">3160x</td>
</tr>
<tr class="covered">
<td class="num">926</td>
<td class="src"><pre><code class="objc">        self.userInfo[MetadataKey] = nil;</code></pre></td>
<td class="coverage">3160x</td>
</tr>
<tr class="covered">
<td class="num">927</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">3160x</td>
</tr>
<tr class="covered">
<td class="num">928</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">5770x</td>
</tr>
<tr class="never">
<td class="num">929</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">930</td>
<td class="src"><pre><code class="objc">- (id)persistentStoreMetadataForKey:(NSString *)key;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">931</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">8660x</td>
</tr>
<tr class="covered">
<td class="num">932</td>
<td class="src"><pre><code class="objc">    NSMutableDictionary *userInfoMetadata = [self metadataInfo];</code></pre></td>
<td class="coverage">8660x</td>
</tr>
<tr class="covered">
<td class="num">933</td>
<td class="src"><pre><code class="objc">    id result = userInfoMetadata[key];</code></pre></td>
<td class="coverage">8660x</td>
</tr>
<tr class="covered">
<td class="num">934</td>
<td class="src"><pre><code class="objc">    if (nil == result) {</code></pre></td>
<td class="coverage">8660x</td>
</tr>
<tr class="covered">
<td class="num">935</td>
<td class="src"><pre><code class="objc">        NSDictionary *storedMetadata = [self.persistentStoreCoordinator metadataForPersistentStore:[self firstPersistentStore]];</code></pre></td>
<td class="coverage">7390x</td>
</tr>
<tr class="covered">
<td class="num">936</td>
<td class="src"><pre><code class="objc">        result = storedMetadata[key];</code></pre></td>
<td class="coverage">7390x</td>
</tr>
<tr class="covered">
<td class="num">937</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">7390x</td>
</tr>
<tr class="covered">
<td class="num">938</td>
<td class="src"><pre><code class="objc">    if ([result isKindOfClass:[NSNull class]]) return nil;</code></pre></td>
<td class="coverage">8660x</td>
</tr>
<tr class="covered">
<td class="num">939</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage">8660x</td>
</tr>
<tr class="covered">
<td class="num">940</td>
<td class="src"><pre><code class="objc">    return result;</code></pre></td>
<td class="coverage">8660x</td>
</tr>
<tr class="covered">
<td class="num">941</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">8660x</td>
</tr>
<tr class="never">
<td class="num">942</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">943</td>
<td class="src"><pre><code class="objc">- (void)setPersistentStoreMetadata:(id)value forKey:(NSString *)key;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">944</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">4750x</td>
</tr>
<tr class="covered">
<td class="num">945</td>
<td class="src"><pre><code class="objc">    VerifyReturn(key != nil);</code></pre></td>
<td class="coverage">4750x</td>
</tr>
<tr class="covered">
<td class="num">946</td>
<td class="src"><pre><code class="objc">    NSMutableDictionary *mutableMetadata = [self metadataInfo];</code></pre></td>
<td class="coverage">4750x</td>
</tr>
<tr class="covered">
<td class="num">947</td>
<td class="src"><pre><code class="objc">    if (value) {</code></pre></td>
<td class="coverage">4750x</td>
</tr>
<tr class="covered">
<td class="num">948</td>
<td class="src"><pre><code class="objc">        mutableMetadata[key] = value;</code></pre></td>
<td class="coverage">1710x</td>
</tr>
<tr class="covered">
<td class="num">949</td>
<td class="src"><pre><code class="objc">    } else {</code></pre></td>
<td class="coverage">3030x</td>
</tr>
<tr class="covered">
<td class="num">950</td>
<td class="src"><pre><code class="objc">        mutableMetadata[key] = [NSNull null];</code></pre></td>
<td class="coverage">3030x</td>
</tr>
<tr class="covered">
<td class="num">951</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">3030x</td>
</tr>
<tr class="covered">
<td class="num">952</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">4750x</td>
</tr>
<tr class="never">
<td class="num">953</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">954</td>
<td class="src"><pre><code class="objc">- (NSPersistentStore *)firstPersistentStore</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">955</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">19500x</td>
</tr>
<tr class="covered">
<td class="num">956</td>
<td class="src"><pre><code class="objc">    NSArray *stores = [self.persistentStoreCoordinator persistentStores];</code></pre></td>
<td class="coverage">19500x</td>
</tr>
<tr class="covered">
<td class="num">957</td>
<td class="src"><pre><code class="objc">    NSAssert(stores.count == 1, @"Invalid number of stores");</code></pre></td>
<td class="coverage">19500x</td>
</tr>
<tr class="covered">
<td class="num">958</td>
<td class="src"><pre><code class="objc">    NSPersistentStore *store = stores[0];</code></pre></td>
<td class="coverage">19500x</td>
</tr>
<tr class="covered">
<td class="num">959</td>
<td class="src"><pre><code class="objc">    return store;</code></pre></td>
<td class="coverage">19500x</td>
</tr>
<tr class="covered">
<td class="num">960</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">19500x</td>
</tr>
<tr class="never">
<td class="num">961</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">962</td>
<td class="src"><pre><code class="objc">+ (NSManagedObjectModel *)loadManagedObjectModel;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">963</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">1490x</td>
</tr>
<tr class="covered">
<td class="num">964</td>
<td class="src"><pre><code class="objc">    // On iOS we can't put the model into the library. We need to load it from the test bundle.</code></pre></td>
<td class="coverage">1490x</td>
</tr>
<tr class="covered">
<td class="num">965</td>
<td class="src"><pre><code class="objc">    // On OS X, we'll load it from the zmessaging Framework.</code></pre></td>
<td class="coverage">1490x</td>
</tr>
<tr class="covered">
<td class="num">966</td>
<td class="src"><pre><code class="objc">    NSBundle *modelBundle = [NSBundle bundleForClass:[ZMManagedObject class]];</code></pre></td>
<td class="coverage">1490x</td>
</tr>
<tr class="covered">
<td class="num">967</td>
<td class="src"><pre><code class="objc">    NSManagedObjectModel *result = [NSManagedObjectModel mergedModelFromBundles:@[modelBundle]];</code></pre></td>
<td class="coverage">1490x</td>
</tr>
<tr class="covered">
<td class="num">968</td>
<td class="src"><pre><code class="objc">    NSAssert(result != nil, @"Unable to load zmessaging model.");</code></pre></td>
<td class="coverage">1490x</td>
</tr>
<tr class="covered">
<td class="num">969</td>
<td class="src"><pre><code class="objc">    return result;</code></pre></td>
<td class="coverage">1490x</td>
</tr>
<tr class="covered">
<td class="num">970</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">1490x</td>
</tr>
<tr class="never">
<td class="num">971</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">972</td>
<td class="src"><pre><code class="objc">- (NSArray *)executeFetchRequestOrAssert:(NSFetchRequest *)request;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="missed">
<td class="num">973</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">974</td>
<td class="src"><pre><code class="objc">    NSError *error;</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">975</td>
<td class="src"><pre><code class="objc">    NSArray *result = [self executeFetchRequest:request error:&amp;error];</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">976</td>
<td class="src"><pre><code class="objc">    RequireString(result != nil, "Error in fetching: %lu", (long) error.code);</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">977</td>
<td class="src"><pre><code class="objc">    return result;</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">978</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="never">
<td class="num">979</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">980</td>
<td class="src"><pre><code class="objc">- (void)continuouslyCheckForUnsavedChanges;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">981</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">982</td>
<td class="src"><pre><code class="objc">    static dispatch_once_t onceToken;</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">983</td>
<td class="src"><pre><code class="objc">    dispatch_once(&amp;onceToken, ^{</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">984</td>
<td class="src"><pre><code class="objc">        if (! [[NSUserDefaults standardUserDefaults] boolForKey:@"ZMCheckForUnsavedChangesOnUIContext"]) {</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">985</td>
<td class="src"><pre><code class="objc">            return;</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">986</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="missed">
<td class="num">987</td>
<td class="src"><pre><code class="objc">        dispatch_async(dispatch_get_main_queue(), ^{</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">988</td>
<td class="src"><pre><code class="objc">            [self checkForUnsavedChanges];</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">989</td>
<td class="src"><pre><code class="objc">        });</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">990</td>
<td class="src"><pre><code class="objc">    });</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">991</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="never">
<td class="num">992</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">993</td>
<td class="src"><pre><code class="objc">- (void)checkForUnsavedChanges;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="missed">
<td class="num">994</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">995</td>
<td class="src"><pre><code class="objc">    // When ZMCheckForUnsavedChangesOnUIContext is set to YES, this will log a warning when</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">996</td>
<td class="src"><pre><code class="objc">    // the UI forgets to wrap changes inside a call to -performChanges:</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">997</td>
<td class="src"><pre><code class="objc">    //</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">998</td>
<td class="src"><pre><code class="objc">    // To use this, pass</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">999</td>
<td class="src"><pre><code class="objc">    //     -ZMCheckForUnsavedChangesOnUIContext YES</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">1000</td>
<td class="src"><pre><code class="objc">    // as a launch argument.</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">1001</td>
<td class="src"><pre><code class="objc">    //</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">1002</td>
<td class="src"><pre><code class="objc">    if ([self hasChanges]) {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">1003</td>
<td class="src"><pre><code class="objc">        ZMLogWarn(@"User Interface context is out of sync.");</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">1004</td>
<td class="src"><pre><code class="objc">        ZMLogWarn(@"Context &lt;%@: %p&gt; has unsaved changes:", self.class, self);</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">1005</td>
<td class="src"><pre><code class="objc">        ZMLogWarn(@"Please use -[ZMUserSession performChanges:].");</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">1006</td>
<td class="src"><pre><code class="objc">        for (NSManagedObject *mo in self.updatedObjects) {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">1007</td>
<td class="src"><pre><code class="objc">            ZMLogWarn(@"    &lt;%@: %p&gt;: %@", mo.class, mo, [mo.changedValues.allKeys componentsJoinedByString:@", "]);</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">1008</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">1009</td>
<td class="src"><pre><code class="objc">        for (NSManagedObject *mo in self.insertedObjects) {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">1010</td>
<td class="src"><pre><code class="objc">            ZMLogWarn(@"    &lt;%@: %p&gt; (inserted)", mo.class, mo);</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">1011</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">1012</td>
<td class="src"><pre><code class="objc">        __builtin_trap();</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">1013</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">1014</td>
<td class="src"><pre><code class="objc">    [self performSelector:_cmd withObject:nil afterDelay:0.5];</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">1015</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="never">
<td class="num">1016</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">1017</td>
<td class="src"><pre><code class="objc">@end</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">1018</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">1019</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">1020</td>
<td class="src"><pre><code class="objc">static dispatch_queue_t singletonContextIsolation(void)</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">1021</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">5890x</td>
</tr>
<tr class="covered">
<td class="num">1022</td>
<td class="src"><pre><code class="objc">    static dispatch_queue_t queue;</code></pre></td>
<td class="coverage">5890x</td>
</tr>
<tr class="covered">
<td class="num">1023</td>
<td class="src"><pre><code class="objc">    static dispatch_once_t onceToken;</code></pre></td>
<td class="coverage">5890x</td>
</tr>
<tr class="covered">
<td class="num">1024</td>
<td class="src"><pre><code class="objc">    dispatch_once(&amp;onceToken, ^{</code></pre></td>
<td class="coverage">5890x</td>
</tr>
<tr class="covered">
<td class="num">1025</td>
<td class="src"><pre><code class="objc">        queue = dispatch_queue_create("moc.singletonContextIsolation", 0);</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">1026</td>
<td class="src"><pre><code class="objc">    });</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">1027</td>
<td class="src"><pre><code class="objc">    return queue;</code></pre></td>
<td class="coverage">5890x</td>
</tr>
<tr class="covered">
<td class="num">1028</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">5890x</td>
</tr>
<tr class="never">
<td class="num">1029</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">1030</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">1031</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">1032</td>
<td class="src"><pre><code class="objc">@implementation NSManagedObjectContext (zmessagingTests)</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">1033</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">1034</td>
<td class="src"><pre><code class="objc">- (void)enableForceRollback;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">1035</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">1036</td>
<td class="src"><pre><code class="objc">    self.userInfo[IsFailingToSave] = @YES;</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="covered">
<td class="num">1037</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">1x</td>
</tr>
<tr class="never">
<td class="num">1038</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">1039</td>
<td class="src"><pre><code class="objc">- (void)disableForceRollback;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="missed">
<td class="num">1040</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">1041</td>
<td class="src"><pre><code class="objc">    [self.userInfo removeObjectForKey:IsFailingToSave];</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">1042</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="never">
<td class="num">1043</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">1044</td>
<td class="src"><pre><code class="objc">- (void)disableSaves;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="missed">
<td class="num">1045</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">1046</td>
<td class="src"><pre><code class="objc">    self.userInfo[IsSaveDisabled] = @YES;</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">1047</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="never">
<td class="num">1048</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">1049</td>
<td class="src"><pre><code class="objc">- (void)enableSaves;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="missed">
<td class="num">1050</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">1051</td>
<td class="src"><pre><code class="objc">    [self.userInfo removeObjectForKey:IsSaveDisabled];</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">1052</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="never">
<td class="num">1053</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">1054</td>
<td class="src"><pre><code class="objc">- (void)markAsSyncContext;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">1055</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">3030x</td>
</tr>
<tr class="covered">
<td class="num">1056</td>
<td class="src"><pre><code class="objc">    [self performBlockAndWait:^{</code></pre></td>
<td class="coverage">3030x</td>
</tr>
<tr class="covered">
<td class="num">1057</td>
<td class="src"><pre><code class="objc">        self.userInfo[IsSyncContextKey] = @YES;</code></pre></td>
<td class="coverage">3030x</td>
</tr>
<tr class="covered">
<td class="num">1058</td>
<td class="src"><pre><code class="objc">    }];</code></pre></td>
<td class="coverage">3030x</td>
</tr>
<tr class="covered">
<td class="num">1059</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">3030x</td>
</tr>
<tr class="never">
<td class="num">1060</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">1061</td>
<td class="src"><pre><code class="objc">- (void)markAsSearchContext;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">1062</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">1063</td>
<td class="src"><pre><code class="objc">    [self performBlockAndWait:^{</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">1064</td>
<td class="src"><pre><code class="objc">        self.userInfo[IsSearchContextKey] = @YES;</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">1065</td>
<td class="src"><pre><code class="objc">    }];</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="covered">
<td class="num">1066</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">1470x</td>
</tr>
<tr class="never">
<td class="num">1067</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">1068</td>
<td class="src"><pre><code class="objc">- (void)markAsUIContext</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">1069</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">3060x</td>
</tr>
<tr class="covered">
<td class="num">1070</td>
<td class="src"><pre><code class="objc">    [self performBlockAndWait:^{</code></pre></td>
<td class="coverage">3060x</td>
</tr>
<tr class="covered">
<td class="num">1071</td>
<td class="src"><pre><code class="objc">        self.userInfo[IsUserInterfaceContextKey] = @YES;</code></pre></td>
<td class="coverage">3060x</td>
</tr>
<tr class="covered">
<td class="num">1072</td>
<td class="src"><pre><code class="objc">        self.displayNameGenerator = [[ZMUserDisplayNameGenerator alloc] initWithManagedObjectContext:self];</code></pre></td>
<td class="coverage">3060x</td>
</tr>
<tr class="covered">
<td class="num">1073</td>
<td class="src"><pre><code class="objc">    }];</code></pre></td>
<td class="coverage">3060x</td>
</tr>
<tr class="covered">
<td class="num">1074</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">3060x</td>
</tr>
<tr class="never">
<td class="num">1075</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">1076</td>
<td class="src"><pre><code class="objc">- (void)resetContextType</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">1077</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">199x</td>
</tr>
<tr class="covered">
<td class="num">1078</td>
<td class="src"><pre><code class="objc">    [self performBlockAndWait:^{</code></pre></td>
<td class="coverage">199x</td>
</tr>
<tr class="covered">
<td class="num">1079</td>
<td class="src"><pre><code class="objc">        self.userInfo[IsSyncContextKey] = @NO;</code></pre></td>
<td class="coverage">199x</td>
</tr>
<tr class="covered">
<td class="num">1080</td>
<td class="src"><pre><code class="objc">        self.userInfo[IsUserInterfaceContextKey] = @NO;</code></pre></td>
<td class="coverage">199x</td>
</tr>
<tr class="covered">
<td class="num">1081</td>
<td class="src"><pre><code class="objc">        self.userInfo[IsSearchContextKey] = @NO;</code></pre></td>
<td class="coverage">199x</td>
</tr>
<tr class="covered">
<td class="num">1082</td>
<td class="src"><pre><code class="objc">    }];</code></pre></td>
<td class="coverage">199x</td>
</tr>
<tr class="covered">
<td class="num">1083</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">199x</td>
</tr>
<tr class="never">
<td class="num">1084</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">1085</td>
<td class="src"><pre><code class="objc">- (void)disableObjectRefresh;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">1086</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">2940x</td>
</tr>
<tr class="covered">
<td class="num">1087</td>
<td class="src"><pre><code class="objc">    self.userInfo[IsRefreshOfObjectsDisabled] = @YES;</code></pre></td>
<td class="coverage">2940x</td>
</tr>
<tr class="covered">
<td class="num">1088</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">2940x</td>
</tr>
<tr class="never">
<td class="num">1089</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">1090</td>
<td class="src"><pre><code class="objc">@end</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">1091</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">1092</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">1093</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">1094</td>
<td class="src"><pre><code class="objc">@implementation NSManagedObjectContext (CleanUp)</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">1095</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">1096</td>
<td class="src"><pre><code class="objc">- (void)refreshUnneededObjects</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">1097</td>
<td class="src"><pre><code class="objc">{</code></pre></td>
<td class="coverage">2680x</td>
</tr>
<tr class="covered">
<td class="num">1098</td>
<td class="src"><pre><code class="objc">    if(self.zm_shouldRefreshObjectsWithSyncContextPolicy) {</code></pre></td>
<td class="coverage">2680x</td>
</tr>
<tr class="covered">
<td class="num">1099</td>
<td class="src"><pre><code class="objc">        [ZMConversation refreshObjectsThatAreNotNeededInSyncContext:self];</code></pre></td>
<td class="coverage">342x</td>
</tr>
<tr class="covered">
<td class="num">1100</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage">342x</td>
</tr>
<tr class="covered">
<td class="num">1101</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage">2680x</td>
</tr>
<tr class="never">
<td class="num">1102</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">1103</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">1104</td>
<td class="src"><pre><code class="objc">@end</code></pre></td>
<td class="coverage"></td>
</tr>
</table>
</div></div>
<footer><div class="row">
<p><a href="https://github.com/SlatherOrg/slather">Fork me on Github</a></p>
<p>&copy; 2016 Slather</p>
</div></footer><script src="highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script>
</body>
</html>
